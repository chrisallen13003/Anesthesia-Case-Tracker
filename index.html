
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Anesthesia Companion — v36 (Adult)</title>
<style>
  :root{
    --bg:#0b1220; --surface:#0f172aee; --surface-ghost:#0f172a66; --border:#334155;
    --text:#e2e8f0; --muted:#cbd5e1; --muted-2:#94a3b8; --primary:#2563eb; --primary-600:#1d4ed8;
    --accent:#22c55e; --warn:#f59e0b; --danger:#e11d48; --highlight:#ffef9f;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --surface:#ffffff; --surface-ghost:#eef2f7; --border:#cbd5e1;
    --text:#0f172a; --muted:#334155; --muted-2:#475569; --primary:#0ea5e9; --primary-600:#0284c7;
    --accent:#16a34a; --warn:#b45309; --danger:#b91c1c; --highlight:#fff6b3;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
       background:var(--bg);color:var(--text)}
  a{color:var(--primary)}
  header{position:sticky;top:0;z-index:20;background:rgba(0,0,0,.15);
         backdrop-filter: blur(8px); border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:900;letter-spacing:.02em}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;flex:1 1 600px}
  .tab{border:1px solid var(--border);border-radius:9999px;padding:.6rem .9rem;font-weight:800;text-align:center;
       background:var(--surface-ghost); color:var(--text); cursor:pointer; user-select:none}
  .tab.active{background:var(--primary); border-color:var(--primary); color:#fff; box-shadow:0 8px 18px rgba(37,99,235,.35)}
  .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{border-radius:9999px;padding:.55rem .9rem;border:1px solid var(--border);background:var(--surface-ghost);
       color:var(--text);font-weight:800;cursor:pointer}
  .btn-primary{border-color:var(--primary-600);background:var(--primary);color:#fff}
  .btn-danger{border-color:var(--danger);background:var(--danger);color:#fff}
  main{max-width:1200px;margin:0 auto;padding:16px}
  .section{display:none}
  .section.active{display:block}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;
        box-shadow:0 8px 24px rgba(0,0,0,.25); margin-bottom:16px}
  .ghost{background:var(--surface-ghost);border:1px solid var(--border);border-radius:14px;padding:16px}
  .h2{font-size:1.6rem;font-weight:900;letter-spacing:-.01em;margin:0 0 8px}
  .small{font-size:.95rem;color:var(--muted)}
  .divider{height:1px;background:var(--border);margin:10px 0}
  label{font-weight:700;font-size:.9rem;margin-top:6px;display:block;color:var(--muted)}
  .input, select, textarea{width:100%;border:1px solid var(--border);border-radius:9999px;padding:.65rem .9rem;
                           background:var(--surface);color:var(--text)}
  textarea{border-radius:12px}
  select, select option{background:var(--surface);color:var(--text)}
  .badge{display:inline-block;border-radius:9999px;padding:.25rem .6rem;font-weight:800;font-size:.8rem}
  .badge-soft{background:var(--border);color:var(--text)}
  .badge-accent{background:linear-gradient(90deg,var(--accent),var(--primary));color:#fff}
  .chip{display:inline-block;border:1px solid var(--border);border-radius:9999px;padding:.15rem .5rem;margin-right:.25rem}
  .grid{display:grid;gap:10px}
  @media (min-width:768px){ .g-3{grid-template-columns:repeat(3,1fr)} .g-2{grid-template-columns:repeat(2,1fr)}}
  .cat-header{background:var(--surface-ghost);border:2px solid var(--border);border-radius:10px;padding:.5rem .8rem;
              font-weight:900;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .drug-row{display:flex;justify-content:space-between;gap:.75rem;align-items:center;padding:.6rem .75rem;
            border-bottom:1px solid var(--border)}
  .dose-base{color:var(--muted);font-size:.95rem}
  .mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .mask.active{display:flex}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:800px;width:92vw;
         max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .modal .header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .modal .body{padding:14px}
  .tabs-mini{display:flex;gap:8px;margin-bottom:10px}
  .tabs-mini .btn{padding:.4rem .7rem}
  .case-card{border:1px solid var(--border);background:var(--surface-ghost);border-radius:12px;padding:.6rem .75rem;cursor:pointer}
  .muted{color:var(--muted-2);font-size:.9rem}
  @media (max-width:640px){ .tabs{grid-template-columns:repeat(2,1fr)} }
  body[data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator,
  body[data-theme="dark"] input[type="time"]::-webkit-calendar-picker-indicator{ filter: invert(1) brightness(1.4); }
  footer{max-width:1200px;margin:12px auto 20px;color:var(--muted-2);font-size:.85rem}
  .hl{background:var(--highlight);padding:0 .25rem;border-radius:8px;color:#000}

.la-table th, .la-table td{ padding:12px; font-size:15px; }
.la-table tbody tr:nth-child(odd){ background: var(--surface-ghost); }
@media (min-width: 768px){
  .la-table th, .la-table td{ padding:14px; font-size:16px; }
}
</style>
<style>
/* === LA bar styles (updated) === */
.la-slider-wrap{display:flex;align-items:center;gap:8px}
.la-slider{width:180px; appearance:none; height:8px; border-radius:6px; outline:none; background:#ddd}
.la-slider::-webkit-slider-thumb{appearance:none; width:16px; height:16px; border-radius:50%; background:#111; border:2px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,0.2)}
.la-slider::-moz-range-thumb{width:16px; height:16px; border-radius:50%; background:#111; border:2px solid #fff}
</style>
<style>
/* === LA bar styles (updated) === */
.la-bar-wrap{display:flex;align-items:center;gap:8px;display:flex;align-items:center;gap:8px}
.la-bar{width:220px;height:10px;border-radius:6px;background:#e0e0e0;position:relative;overflow:hidden}
.la-fill{height:100%;width:0%;border-radius:6px;background:#4caf50}

#laOverallPct{color:#4caf50;font-weight:600}
</style>
</head>
<body data-theme="dark">
<header>
<div class="wrap">
<div class="brand">Anesthesia Companion (Adult)</div>
<div class="tabs">
<div class="tab active" data-target="tab-case">Case Tracker</div>
<div class="tab" data-target="tab-meds">Medications</div>
<div class="tab" data-target="tab-pearls">Clinical Pearls</div>
<div class="tab" data-target="tab-calcs">Calculators</div>
</div>
<div class="right">
<span class="small">Theme</span>
<button class="btn" id="themeToggle">Dark / Light</button>
</div>
</div>
</header>
<main>
<!-- CASE TRACKER -->
<section class="section active" id="tab-case">
<div class="card">
<h2 class="h2">New Case Entry</h2>
<div class="divider"></div>
<div class="grid g-3">
<div><label>Date</label><input class="input" id="cDate" type="date"/></div>
<div><label>Anesthesia Start</label><input class="input" id="cStart" type="time"/></div>
<div><label>Anesthesia End</label><input class="input" id="cEnd" type="time"/></div>
<div><label>Age</label><input class="input" id="cAge" placeholder="e.g., 64" type="number"/></div>
<div><label>Sex</label>
<select class="input" id="cSex"><option value=""></option><option>Male</option><option>Female</option><option>Other</option></select>
</div>
<div><label>ASA (with E)</label>
<select class="input" id="cASA">
<option value=""></option>
<option value="I">ASA 1 — non-smoker / minimal alcohol use</option>
<option value="II">ASA 2 — smoker / pregnant / controlled HTN or DM</option>
<option value="III">ASA 3 — poorly controlled DM or HTN, BMI ≥ 40, > 3 mo MI/CVA</option>
<option value="IV">ASA 4 — < 3 mo MI/CVA, severe systemic disease</option>
<option value="V">ASA 5 — not expected to survive</option>
<option value="VI">ASA 6 — organ donor</option>
<option value="I-E">ASA 1-E — Emergency</option>
<option value="II-E">ASA 2-E — Emergency</option>
<option value="III-E">ASA 3-E — Emergency</option>
<option value="IV-E">ASA 4-E — Emergency</option>
<option value="V-E">ASA 5-E — Emergency</option>
</select>
</div>
<div style="grid-column: span 2 / span 2"><label>Procedure</label><input class="input" id="cProc" placeholder="e.g., Lap chole"/></div>
<div><label>Anesthetic</label><input class="input" id="cAnes" placeholder="e.g., General, MAC, Regional"/></div>
<div><label>Airway</label><input class="input" id="cAirway" placeholder="e.g., ETT, LMA, Mask"/></div>
<div><label>Case Type</label><input class="input" id="cType" placeholder="e.g., General, OB, Neuro, Trauma"/></div>
<div style="grid-column: span 3 / span 3"><label>Notes</label><textarea class="input" id="cNotes" placeholder="e.g., Procedures (A-Line, CVC, POCUS), meds, complications, etc." rows="3"></textarea></div>
</div>
<div style="display:flex;gap:8px;margin-top:10px">
<button class="btn-primary" id="saveCase">Save Case</button>
<button class="btn" id="clearFields">Clear Fields</button>
</div>
</div>
<div class="ghost">
<div style="display:flex;justify-content:space-between;align-items:center">
<h3 style="margin:0;font-weight:900">Saved Cases</h3>
<div class="small" id="sumBar"></div>
</div>
<div class="divider"></div>
<div class="grid" id="caseList" style="grid-template-columns:1fr;gap:10px"></div>
<div class="divider"></div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" id="exportAll">Export CSV (all)</button>
<button class="btn-danger" id="clearAll">Clear All</button>
</div>
</div>
<!-- Case Modal -->
<div class="mask" id="caseMask"><div class="modal">
<div class="header"><div class="h2" style="font-size:1.2rem">Case Details</div><button class="btn-danger" id="caseClose">Close</button></div>
<div class="body small" id="caseBody"></div>
<div class="divider"></div>
<div class="body" style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" id="caseEdit">Edit</button>
<button class="btn-primary" id="caseSave" style="display:none">Save Changes</button>
<button class="btn" id="caseExport">Export</button>
<button class="btn-danger" id="caseDelete">Delete</button>
</div>
</div></div>
</section>
<!-- MEDICATIONS -->
<section class="section" id="tab-meds">
<div class="card">
<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
<div><label>Patient Weight (kg)</label><input class="input" id="ptWt" min="0" placeholder="e.g., 70" step="0.1" style="width:140px" type="number"/></div>
<div style="flex:1 1 240px"><label>Search drugs</label><input class="input" id="searchDrug" placeholder="Start typing a drug name..." type="text"/></div>
<div style="display:flex;gap:8px">
<button class="btn-primary" id="btnExpandMeds">Expand All</button>
<button class="btn" id="btnCollapseMeds">Collapse All</button>
</div>
</div>
<div class="divider"></div>
<div class="grid" id="medList" style="grid-template-columns:1fr;gap:14px"></div>
</div>
</section>
<!-- CLINICAL PEARLS -->
<section class="section" id="tab-pearls">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<h2 class="h2">Clinical Pearls</h2>
<div style="display:flex;gap:8px">
<button class="btn" id="btnExpandPearls">Expand All</button>
<button class="btn" id="btnCollapsePearls">Collapse All</button>
</div>
</div>
<div class="divider"></div>
<details class="ghost" open="">
<summary class="cat-header">Anesthesia Mnemonics</summary>
<div class="body small">
<div><span class="chip">MS MAIDS</span> Monitors, Suction, Machine, Airway, IV, Drugs, Special</div>
<div><span class="chip">AMPLE</span> Allergies, Meds, Past hx, Last meal, Events</div>
<div><span class="chip">SOAP-ME</span> Suction, Oxygen, Airway, Position, Monitors/Medications, Equipment/ETT</div>
<div><span class="chip">DRS ABCD</span> Danger, Response, Shout, Airway, Breathing, Circulation, Defib/Drugs</div>
</div>
</details>
<details class="ghost">
<summary class="cat-header">Airway Management &amp; Laryngospasm</summary>
<div class="body small">
<div class="h2" style="font-size:1rem">Difficult Airway (Simplified)</div>
<ol style="margin-left:18px">
<li>Prepare: backup devices (VL, bougie, SGA), suction, O₂, help, preoxygenate.</li>
<li>Optimize first attempt: ramp obese, use VL early, ELM, consider bougie.</li>
<li>Failed intubation but ventilation adequate: awaken patient or SGA as bridge.</li>
<li>CICO: call help; emergency front-of-neck access (cricothyrotomy).</li>
<li>Post-event: document, debrief, plan awake strategy for future.</li>
</ol>
<div class="divider"></div>
<div class="h2" style="font-size:1rem">Laryngospasm</div>
<ul style="margin-left:18px">
<li>Jaw thrust, CPAP 10–20 cmH₂O with 100% O₂, remove stimulus.</li>
<li>Deepen: propofol 0.5–1 mg/kg IV.</li>
<li>Refractory: succinylcholine 0.5–1 mg/kg IV (2 mg/kg IM).</li>
</ul>
<div class="divider"></div><div class="h2" style="font-size:1rem">Extubation Criteria</div><ul style="margin-left:18px"><li><b>Respiratory:</b> TV &gt; 5 mL/kg, VC &gt; 10–15 mL/kg, RR &lt; 30/min, SpO₂ &gt; 90% on FiO₂ ≤ 40%</li><li><b>Protective Reflexes:</b> intact gag/cough, able to follow commands</li><li><b>Neuromuscular Reversal:</b> TOF ≥ 0.9, sustained head lift/hand grip</li><li><b>Hemodynamics:</b> stable BP/HR, normothermia</li></ul>
</div>
</details>
<details class="ghost">
<summary class="cat-header">Airway &amp; Blade Sizes (Adult)</summary>
<div class="body small"><table style="width:100%;border-collapse:collapse">
<thead>
<tr style="background:var(--surface-ghost)">
<th class="badge-soft" style="text-align:left;border:1px solid var(--border);padding:6px">Device</th>
<th class="badge-soft" style="text-align:left;border:1px solid var(--border);padding:6px">Rule of Thumb</th>
<th class="badge-soft" style="text-align:left;border:1px solid var(--border);padding:6px">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border:1px solid var(--border);padding:6px">ETT (female)</td>
<td style="border:1px solid var(--border);padding:6px">7.0–7.5 mm</td>
<td style="border:1px solid var(--border);padding:6px">Depth ~21 cm at teeth</td>
</tr>
<tr>
<td style="border:1px solid var(--border);padding:6px">ETT (male)</td>
<td style="border:1px solid var(--border);padding:6px">7.5–8.0 mm</td>
<td style="border:1px solid var(--border);padding:6px">Depth ~23 cm at teeth</td>
</tr>
<tr>
<td style="border:1px solid var(--border);padding:6px">LMA (by weight)</td>
<td style="border:1px solid var(--border);padding:6px">#3 (30–50 kg), #4 (50–70), #5 (70–100)</td>
<td style="border:1px solid var(--border);padding:6px">Confirm seal</td>
</tr>
</tbody>
</table>
<hr/>
<div class="h2" style="font-size:1rem;margin:.5rem 0">Laryngoscope Blade Sizes</div>
<table style="width:100%;border-collapse:collapse">
<thead>
<tr style="background:var(--surface-ghost)">
<th class="badge-soft" style="text-align:left;border:1px solid var(--border);padding:6px">Blade</th>
<th class="badge-soft" style="text-align:left;border:1px solid var(--border);padding:6px">Typical Adult Sizes</th>
<th class="badge-soft" style="text-align:left;border:1px solid var(--border);padding:6px">Rule of Thumb</th>
</tr>
</thead>
<tbody>
<tr><td style="border:1px solid var(--border);padding:6px">Macintosh (curved)</td>
<td style="border:1px solid var(--border);padding:6px">Size 3 (most females), Size 4 (most males/tall/large)</td>
<td style="border:1px solid var(--border);padding:6px">If height ≥ 180 cm or large habitus → Mac 4; otherwise Mac 3</td></tr>
<tr><td style="border:1px solid var(--border);padding:6px">Miller (straight)</td>
<td style="border:1px solid var(--border);padding:6px">Size 2–3 adults (3 common), Size 4 tall/large</td>
<td style="border:1px solid var(--border);padding:6px">Prefer when anterior airway/limited mouth opening; pick 3, go up if exposure poor</td></tr>
<tr><td style="border:1px solid var(--border);padding:6px">Video (Mac or Hyperangulated)</td>
<td style="border:1px solid var(--border);padding:6px">Use Mac 3/4 equivalents; hyperangulated 3 common</td>
<td style="border:1px solid var(--border);padding:6px">Match to Mac size; consider hyperangulated if anticipated difficult airway</td></tr>
</tbody>
</table>
<div class="small" style="margin-top:.5rem">
<b>Selection tips:</b> Check dentition, mouth opening, thyromental distance. Have one size up/down ready. Combine with the ETT/OPA/NPA “rule of thumb” above.
</div>
</div>
</details>
<details class="ghost">
<summary class="cat-header">Vasoactive Cheat Sheet</summary>
<div class="body small" style="overflow:auto">
<table style="width:100%;border-collapse:collapse">
<thead>
<tr style="background:var(--surface-ghost)">
<th style="text-align:left;border:1px solid var(--border);padding:6px">Agent</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">Receptors</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">CO</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">HR</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">SVR</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">Typical Use</th>
</tr>
</thead>
<tbody>
<tr><td style="border:1px solid var(--border);padding:6px">Phenylephrine</td><td style="border:1px solid var(--border);padding:6px">α1</td><td style="border:1px solid var(--border);padding:6px">↓/—</td><td style="border:1px solid var(--border);padding:6px">↓ (reflex)</td><td style="border:1px solid var(--border);padding:6px">↑↑</td><td style="border:1px solid var(--border);padding:6px">Post-induction hypotension</td></tr>
<tr><td style="border:1px solid var(--border);padding:6px">Ephedrine</td><td style="border:1px solid var(--border);padding:6px">Indirect NE + α/β</td><td style="border:1px solid var(--border);padding:6px">↑</td><td style="border:1px solid var(--border);padding:6px">↑</td><td style="border:1px solid var(--border);padding:6px">↑/—</td><td style="border:1px solid var(--border);padding:6px">Hypotension with low HR</td></tr>
<tr><td style="border:1px solid var(--border);padding:6px">Norepinephrine</td><td style="border:1px solid var(--border);padding:6px">α1 &gt; β1</td><td style="border:1px solid var(--border);padding:6px">↑/—</td><td style="border:1px solid var(--border);padding:6px">↑/—</td><td style="border:1px solid var(--border);padding:6px">↑↑</td><td style="border:1px solid var(--border);padding:6px">Vasoplegia</td></tr>
<tr><td style="border:1px solid var(--border);padding:6px">Vasopressin</td><td style="border:1px solid var(--border);padding:6px">V1</td><td style="border:1px solid var(--border);padding:6px">—</td><td style="border:1px solid var(--border);padding:6px">—</td><td style="border:1px solid var(--border);padding:6px">↑↑</td><td style="border:1px solid var(--border);padding:6px">Refractory vasoplegia</td></tr>
<tr><td style="border:1px solid var(--border);padding:6px">Esmolol</td><td style="border:1px solid var(--border);padding:6px">β1 blocker</td><td style="border:1px solid var(--border);padding:6px">↓</td><td style="border:1px solid var(--border);padding:6px">↓</td><td style="border:1px solid var(--border);padding:6px">—</td><td style="border:1px solid var(--border);padding:6px">Blunt tachycardia/HTN</td></tr>
<tr><td style="border:1px solid var(--border);padding:6px">Hydralazine</td><td style="border:1px solid var(--border);padding:6px">Direct arterial</td><td style="border:1px solid var(--border);padding:6px">↑ (reflex)</td><td style="border:1px solid var(--border);padding:6px">↑</td><td style="border:1px solid var(--border);padding:6px">↓↓</td><td style="border:1px solid var(--border);padding:6px">Afterload reduction</td></tr>
</tbody>
</table>
</div>
</details>
<details class="ghost">
<summary class="cat-header">Emergencies &amp; Complications</summary>
<div class="body small">
<div><b>MH:</b> Stop triggers, 100% O₂, dantrolene 2.5 mg/kg IV (repeat), treat hyperK+/acidosis, cool, ICU.</div>
<div><b>Anaphylaxis:</b> Epi 10–100 mcg IV (titrate) or 0.3–0.5 mg IM; fluids; H1/H2; steroids; bronchodilators.</div>
<div><b>LAST:</b> Lipid 20% 1.5 mL/kg bolus → 0.25 mL/kg/min; avoid vasopressin/high-dose epi; benzos for seizures.</div>
<div><b>High Spinal:</b> Ventilatory support; phenylephrine/ephedrine; consider low-dose epinephrine if refractory.</div>
</div>
</details>
</div>
<details class="ghost"><summary class="cat-header">Blood Component Therapy &amp; TEG Guide</summary><div class="body small">
<h4>Blood Products</h4>
<ul>
<li><b>PRBCs:</b> 1 unit ↑ Hgb ~1 g/dL, ↑ Hct ~3%. Indications: Hgb &lt;7 (healthy), &lt;8 (cardiac/OB/trauma).</li>
<li><b>FFP:</b> 10–15 mL/kg. Indications: coagulopathy, INR &gt;1.5, reversal of warfarin, bleeding.</li>
<li><b>Platelets:</b> 1 pack ↑ 30–50k/µL. Indications: &lt;50k with bleeding or prior to invasive procedure.</li>
<li><b>Cryoprecipitate:</b> 1 bag/10 kg ↑ fibrinogen 50–75 mg/dL. Indications: fibrinogen &lt;100–150 mg/dL.</li>
</ul>
<h4>TEG Interpretation</h4>
<ul>
<li><b>R (Reaction time):</b> prolonged = factor deficiency → give FFP.</li>
<li><b>K / α-angle:</b> abnormal = fibrinogen deficiency/function → give cryoprecipitate.</li>
<li><b>MA (Max amplitude):</b> low = platelet dysfunction/deficiency → give platelets.</li>
<li><b>LY30:</b> increased = fibrinolysis → give antifibrinolytic (TXA/Amicar).</li>
</ul>
</div></details>
<details class="ghost"><summary class="cat-header">Ventilator Modes Cheat Sheet</summary><div class="body small">
<ul>
<li><b>AC (Assist Control):</b> Full support. Set Vt + rate; all breaths fully supported.</li>
<li><b>SIMV:</b> Set number of mandatory breaths; spontaneous breaths unassisted unless PS added.</li>
<li><b>PSV:</b> Pressure augments spontaneous breaths only; no backup rate.</li>
<li><b>PRVC:</b> Volume-targeted, pressure-limited. Adjusts pressure to reach target Vt.</li>
<li><b>APRV:</b> Inverse ratio CPAP with intermittent release. Useful in ARDS.</li>
</ul>
<p><b>Pearls:</b> Use SIMV+PS or PSV for weaning. AC not ideal for spontaneous weaning (risk of breath-stacking). PRVC/APRV more common in ICU than OR.</p>
</div></details>
</section>
<!-- CALCULATORS -->
<section class="section" id="tab-calcs">
<div class="card">
<h2 class="h2">Patient Inputs</h2>
<div class="divider"></div>
<div class="grid g-3">
<div><label>Height <span class="small" style="margin-left:6px"><select class="input" id="hUnit" style="width:auto;display:inline-block;padding:2px 6px"><option selected="" value="cm">cm</option><option value="in">in</option></select></span></label><input class="input" id="hCm" placeholder="e.g., 170" step="0.1" type="number"/></div>
<div><label>Weight (kg)</label><input class="input" id="wKg" placeholder="e.g., 70" step="0.1" type="number"/></div>
<div><label>Sex</label><select class="input" id="pSex"><option>Male</option><option>Female</option></select></div>
</div>
<div class="grid" style="grid-template-columns:1fr;gap:10px;margin-top:10px">
<div class="ghost">
<div class="h2" style="font-size:1.1rem;margin-bottom:6px">At a Glance</div>
<div class="grid g-3" id="atGlance"></div>
</div>
</div>
<div class="grid" id="surgCalcWrap" style="grid-template-columns:1fr;gap:10px;margin-top:10px">
<div class="card" id="card-periop-fluids">
<div class="h2">Perioperative Fluids</div>
<div class="small">Maintenance/NPO planning side-by-side with surgical replacement targets. Use case details + NPO hours to see both plans together.</div>
<div class="grid g-2" style="margin-top:8px">
<div class="ghost">
<div class="h2" style="font-size:1.1rem;margin-bottom:6px">Maintenance Fluids / NPO Deficit</div>
<div class="grid g-2">
<label>NPO Hours<input class="input" id="npoH" placeholder="e.g., 8" step="0.1" type="number"/></label>
<div>Rate (4-2-1): <span class="badge badge-soft" id="mivfOut">—</span></div>
<div style="grid-column:1/-1">Deficit: <span class="badge badge-soft" id="defOut">—</span></div>
<div style="grid-column:1/-1;color:var(--muted-2);font-size:.85rem">Plan: 50% 1st hr, 25% 2nd, 25% 3rd (plus mIVF).</div>
</div></div>
<div class="ghost">
<div class="h2" style="font-size:1.1rem;margin-bottom:6px">Surgical Fluid Replacement</div>
<div class="grid g-2">
<label>Case Type
        <select class="input" id="surgCase">
<option value="">Select</option>
<option value="2-4">Minimally invasive (laparoscopic): 2–4 ml/kg/hr</option>
<option value="4-6">Moderate tissue trauma: 4–6 ml/kg/hr</option>
<option value="6-8">Major open (e.g., open abdomen): 6–8 ml/kg/hr</option>
<option value="parkland">Burns (Parkland 4 ml/kg/%TBSA)</option>
</select>
</label>
<label id="burnsBox" style="display:none">Burn Size (%TBSA)
        <input class="input" id="burnPct" placeholder="e.g., 30" type="number"/>
</label>
<div style="grid-column:1/-1">
        Rule: <span class="badge badge-soft" id="surgRuleOut">—</span>
</div>
<div style="grid-column:1/-1">
        Calculated Replacement: <span class="badge badge-accent" id="surgFluidOut">—</span>
</div>
<div class="small" style="grid-column:1/-1;color:var(--muted-2)">
        Note: These are pragmatic intraoperative replacement targets and should be individualized using hemodynamics, labs, and EBL.
      </div>
</div></div>
</div>
</div>
<div class="grid g-2" id="row-abl">
<div class="ghost" style="grid-column:1/-1"><div class="ghost">
<div class="h2" style="font-size:1.1rem;margin-bottom:6px">Allowable Blood Loss (ABL)</div>
<div class="grid g-2">
<label>Starting Hct<input class="input" id="hctStart" placeholder="e.g., 40" step="0.1" type="number"/></label>
<label>Target Hct<input class="input" id="hctTarget" placeholder="e.g., 25" step="0.1" type="number"/></label>
<div style="grid-column:1/-1">ABL: <span class="badge badge-accent" id="ablOut">—</span></div>
</div></div>
</div>
<div class="ghost" style="grid-column:1/-1;">
<div class="h2" style="font-size:1.1rem;margin-bottom:6px">Local Anesthetic Max</div>
<div class="grid g-2">
<label>Anesthetic<select class="input" id="laDrug">
<option value="">Select</option>
<option value="lidocaine">Lidocaine</option>
<option value="bupivacaine">Bupivacaine</option>
<option value="ropivacaine">Ropivacaine</option>
<option value="mepivacaine">Mepivacaine</option>
</select></label>
<label>Concentration<select class="input" id="laConc">
<option value="">Select</option>
<option value="0.25">0.25%</option>
<option value="0.5">0.5%</option>
<option value="0.75">0.75%</option>
<option value="1.0">1%</option>
<option value="1.5">1.5%</option>
<option value="2.0">2%</option>
</select></label>
<label>With Epi?<select class="input" id="laEpi"><option value="no">No</option><option value="yes">Yes</option></select></label>
<label>LA Weight (kg)<input class="input" id="laWeight" placeholder="e.g., 70" step="0.1" type="number"/></label>
<div>Max Dose: <span class="badge badge-accent" id="laMaxDose">—</span></div>
<div>Max Volume: <span class="badge badge-accent" id="laMaxVol">—</span></div>
<div class="row" id="laInlineRow" style="display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-top:6px">
<label style="display:flex;flex-direction:column;gap:6px;font-size:14px">Unit
    <select class="input" id="laDoseUnit" style="width:auto;min-width:90px"><option selected="" value="mL">mL</option><option value="mg">mg</option></select>
</label>
<label style="display:flex;flex-direction:column;gap:6px;font-size:14px">Dose Given/Planned
    <input class="input" id="laVolGiven" placeholder="e.g., 20" step="0.1" style="min-width:140px" type="number"/>
</label>
<div style="display:flex;flex-direction:column;gap:6px">
<div class="small">Remaining allowable (this agent)</div>
<div id="laPlanSliderWrap" style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
  <div class="small" style="font-weight:600">Planned vs Max (this agent)</div>
  <div class="la-bar-wrap">
    <div class="la-bar" id="laPlanBar"><div class="la-fill" id="laPlanFill" style="width:0%"></div></div>
    <span class="small" id="laPlanPct">0%</span>
  </div>
  <div class="small" id="laPlanHelper" style="color:var(--muted-2)">Enter drug, concentration, epi, LA weight, and a planned dose.</div>
</div>
  <div class=" -wrap">
    <!-- removed range input -->
    <span class="small" id="laPlanPct">0%</span>
  </div>
  <div class="small" id="laPlanHelper" style="color:var(--muted-2)">Enter drug, concentration, epi, LA weight, and a planned dose.</div>
</div>
<div class="row" style="display:flex;gap:8px;align-items:center">
<span class="badge badge-soft" id="laRemainMg">— mg</span>
<span class="badge badge-soft" id="laRemainMl">— mL</span>
<button class="btn" id="laAutoFill" title="Auto-fill with max safe amount for this agent">Auto‑fill</button>
<button class="btn btn-primary" id="laAdd">Add Agent</button>
<button class="btn" id="laClear">Clear All</button>
</div>
</div>
</div>
<div class="divider" style="height:1px;background:var(--border);margin:8px 0"></div>
<div class="h2" style="font-size:1rem;margin-bottom:6px">Running Total</div>
<div class="grid" id="laTotalsRow" style="display:grid; grid-template-columns: 1fr; gap: 12px; margin-top:6px"></div>

<div style="grid-column:1/span 1" id="laTotalsLeft">
  <div id="laOverallSliderWrap" style="display:flex;flex-direction:column;gap:6px;margin:6px 0">
  <div class="small" style="font-weight:600">Overall LA Total</div>
  <div class="la-bar-wrap">
    <div class="la-bar" id="laOverallBar"><div class="la-fill" id="laOverallFill" style="width:0%"></div> <span class="small" id="laOverallPct" style="margin-left:8px">0%</span>
  </div>
</div>
<div class="ghost" id="lastCalcBox" style="padding:8px;border:1px solid var(--border);border-radius:10px;margin-top:6px">
  <div class="h2" style="font-size:1rem;margin-bottom:6px">LAST Lipid Infusion Protocol (20% Emulsion)</div>
  <div class="small" style="margin-bottom:6px;color:var(--muted-2)">Uses LA Weight (kg)</div>
  <div class="grid g-2">
    <div style="grid-column:1/-1">
      <div class="small"><b>Initial Bolus:</b> <span id="lastBolusMl">—</span> mL (1 min)</div>
    </div>
    <div><div class="small"><b>Infusion (0.25 mL/kg/min):</b></div>
      <div class="small">Rate: <span id="lastInfuse025MlMin">—</span> mL/min</div>
      <div class="small">Rate: <span id="lastInfuse025MlHr">—</span> mL/hr</div>
    </div>
    <div><div class="small"><b>Infusion (0.5 mL/kg/min):</b></div>
      <div class="small">Rate: <span id="lastInfuse05MlMin">—</span> mL/min</div>
      <div class="small">Rate: <span id="lastInfuse05MlHr">—</span> mL/hr</div>
    </div>
    <div style="grid-column:1/-1">
      <div class="small"><b>Max total (first 30 min):</b> <span id="lastMax30Ml">—</span> mL (≈ 10 mL/kg)</div>
    </div>
    <div class="small" style="grid-column:1/-1;color:var(--muted-2)">
      Consider repeat bolus (up to 2) for persistent instability and increase infusion to 0.5 mL/kg/min if needed. Continue infusion ≥10 min after stability.
    </div>
  </div>
</div>

  <div class=" -wrap">
    <!-- removed range input -->
    <span class="small" id="laOverallPct">0%</span>
  </div>
</div>
<div class="small">LA Weight (kg) above is used for each agent’s max (mg/kg).</div>
<div class="small" id="laTotals" style="margin:8px 0"></div>
<div>
<table class="la-table" id="laTable" style="width:100%;border-collapse:collapse">
<thead>
<tr style="background:var(--surface-ghost)">
<th style="text-align:left;border:1px solid var(--border);padding:6px">Agent</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">Conc</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">Epi</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">Vol (mL)</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">Given (mg)</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">Agent Max (mg)</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px">% of Agent Max</th>
<th style="text-align:left;border:1px solid var(--border);padding:6px"></th>
</tr>
</thead>
<tbody id="laTbody">
<tr><td class="small" colspan="8" style="border:1px solid var(--border);padding:8px;color:var(--muted-2)">No agents added yet.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="card" id="card-reconstitution">
  <h2 class="h2">Reconstitution / Dilution</h2>
  <div class="small">Calculate how much stock medication and diluent to combine to reach a target concentration and final volume.</div>
  <div class="divider"></div>

  <div class="grid g-3">
    <label>Stock concentration
      <div class="grid g-2">
        <input class="input" id="rc_stock_val" type="number" inputmode="decimal" step="0.01" placeholder="e.g., 50">
        <select class="input" id="rc_stock_unit">
          <option value="mcg_per_ml">mcg/mL</option>
          <option value="mg_per_ml">mg/mL</option>
        </select>
      </div>
      <div class="small muted">Example: fentanyl 50 mcg/mL</div>
    </label>

    <label>Desired concentration
      <div class="grid g-2">
        <input class="input" id="rc_goal_val" type="number" inputmode="decimal" step="0.01" placeholder="e.g., 10">
        <select class="input" id="rc_goal_unit">
          <option value="mcg_per_ml">mcg/mL</option>
          <option value="mg_per_ml">mg/mL</option>
        </select>
      </div>
      <div class="small muted">What you want in the syringe/bag</div>
    </label>

    <label>Final volume (mL)
      <input class="input" id="rc_final_vol" type="number" inputmode="decimal" step="0.01" placeholder="e.g., 10">
      <div class="small muted">Total volume after dilution</div>
    </label>
  </div>

  <div class="ghost">
    <div class="grid g-3">
      <div><span class="badge badge-accent">Drug (stock): <span id="rc_out_drug">—</span> mL</span></div>
      <div><span class="badge badge-soft">Diluent: <span id="rc_out_dil">—</span> mL</span></div>
      <div><span class="badge badge-soft">Check: <span id="rc_out_check">—</span></span></div>
    </div>
    <div class="small" id="rc_warn" aria-live="polite" style="color:var(--warn)"></div>
  </div>

  <div class="divider"></div>

  <div class="grid g-2">
    <label>Quick preset
      <select class="input" id="rc_preset">
        <option value="">— Select —</option>
        <option value="fentanyl_50_to_10_in_10">Fentanyl 50 mcg/mL → 10 mcg/mL in 10 mL</option>
        <option value="hydromorphone_1_to_0_2_in_10">Hydromorphone 1 mg/mL → 0.2 mg/mL in 10 mL</option>
        <option value="epi_1_to_0_01_in_100">Epinephrine 1 mg/mL → 0.01 mg/mL in 100 mL (1:100,000)</option>
        <option value="ketamine_100_to_10_in_50">Ketamine 100 mg/mL → 10 mg/mL in 50 mL</option>
        <option value="propofol_10_to_1_in_20">Propofol 10 mg/mL → 1 mg/mL in 20 mL</option>
        <option value="phenylephrine_10_to_0_1_in_100">Phenylephrine 10 mg/mL → 0.1 mg/mL in 100 mL</option>
        <option value="norepi_1_to_0_004_in_250">Norepinephrine 1 mg/mL → 0.004 mg/mL in 250 mL</option>
        <option value="vasopressin_20u_per_ml_to_0_4u_per_ml_in_50">Vasopressin 20 U/mL → 0.4 U/mL in 50 mL</option>
        <option value="lidocaine_2_to_1_in_20">Lidocaine 2% (20 mg/mL) → 10 mg/mL in 20 mL</option>
</select>
    </label>
    <div class="small muted">Auto-converts mg↔mcg. Rounds to syringe-friendly values.</div>
  </div>
</div>

</section>
</main>
<!-- Drug Info Modal -->
<div class="mask" id="drugMask"><div class="modal">
<div class="header"><div class="h2" id="drugTitle" style="font-size:1.2rem">Drug</div><button class="btn-danger" id="drugClose">Close</button></div>
<div class="body">
<div class="tabs-mini">
<button class="btn btn-primary" id="drugTabQuick">Quick Pearls</button>
<button class="btn" id="drugTabExpanded">Expanded Info</button>
</div>
<div class="small" id="drugBody"></div>
</div>
</div></div>
<footer class="wrap" style="justify-content:space-between">
<div>v36 — Sep 12, 2025</div>
<div class="small">Local-only • No PHI uploaded • Export CSV supported</div>
</footer>
<script>
/* THEME */
function setTheme(mode){ document.body.setAttribute('data-theme', mode); localStorage.setItem('srna_theme', mode); }
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme') || 'dark';
  setTheme(cur==='dark'?'light':'dark');
});
setTheme(localStorage.getItem('srna_theme') || 'dark');

/* TABS */
const tabs = document.querySelectorAll('.tab');
const sections = {'tab-case':document.getElementById('tab-case'),'tab-meds':document.getElementById('tab-meds'),'tab-pearls':document.getElementById('tab-pearls'),'tab-calcs':document.getElementById('tab-calcs')};
function activateTab(id){ tabs.forEach(t=>t.classList.remove('active')); const activeTab=document.querySelector('.tab[data-target="'+id+'"]'); if(activeTab){activeTab.classList.add('active');} Object.values(sections).forEach(s=>s.classList.remove('active')); if(sections[id]) sections[id].classList.add('active'); localStorage.setItem('srna_last_tab', id); }
tabs.forEach(t=>t.addEventListener('click', ()=>activateTab(t.dataset.target)));
activateTab(localStorage.getItem('srna_last_tab') || 'tab-case');

/* CASE TRACKER */
const KEY='srna_cases_v36';
const $=id=>document.getElementById(id);
const getCases=()=>{ try{return JSON.parse(localStorage.getItem(KEY)||'[]');}catch(e){return [];} };
const saveCases=arr=>localStorage.setItem(KEY, JSON.stringify(arr));
const uid=()=>Math.random().toString(36).slice(2,9);
function durationStr(start,end){ if(!start||!end) return ""; const [sh,sm]=start.split(':').map(Number), [eh,em]=end.split(':').map(Number); let a=sh*60+sm, b=eh*60+em; if(b<a) b+=1440; const d=b-a; return Math.floor(d/60)+'h '+(d%60)+'m'; }
function renderSummary(arr){ const total=arr.length; let mins=0; const asa={}; arr.forEach(c=>{ if(c.start&&c.end){ let [sh,sm]=c.start.split(':').map(Number), [eh,em]=c.end.split(':').map(Number); let a=sh*60+sm, b=eh*60+em; if(b<a) b+=1440; mins+=b-a; } if(c.asa){ asa[c.asa]=(asa[c.asa]||0)+1; } }); const h=Math.floor(mins/60), m=mins%60; const parts=['<span class="badge badge-soft">Cases: '+total+'</span>','<span class="badge badge-soft">Hours: '+h+'h '+m+'m</span>'].concat(Object.entries(asa).map(([k,v])=>'<span class="badge badge-soft">ASA '+k+': '+v+'</span>')); $('sumBar').innerHTML=parts.join(' '); }
function renderCases(){ const arr=getCases(), list=$('caseList'); if(!arr.length){ list.innerHTML='<div class="muted">No cases yet</div>'; renderSummary(arr); return; } list.innerHTML = arr.map(c=>`<div class="case-card" data-id="${c.id}"><div style="font-weight:800">${c.date||''} — ${c.proc||''}</div><div class="muted">${c.anes||''} • ASA ${c.asa||''} • ${c.caseType||''}</div><div class="muted">Duration: ${durationStr(c.start,c.end)}</div></div>`).join(''); renderSummary(arr); }
function clearForm(){ ['cDate','cStart','cEnd','cAge','cSex','cASA','cProc','cAnes','cAirway','cType','cNotes'].forEach(id=>$(id).value=''); }
$('saveCase').addEventListener('click', ()=>{ const c={ id:uid(), date:$('cDate').value, start:$('cStart').value, end:$('cEnd').value, age:$('cAge').value, sex:$('cSex').value, asa:$('cASA').value, proc:$('cProc').value, anes:$('cAnes').value, airway:$('cAirway').value, caseType:$('cType').value, notes:$('cNotes').value }; const arr=getCases(); arr.push(c); saveCases(arr); renderCases(); clearForm(); });
$('clearFields').addEventListener('click', clearForm);
$('clearAll').addEventListener('click', ()=>{ if(confirm('Delete all saved cases?')){ saveCases([]); renderCases(); }});
$('exportAll').addEventListener('click', ()=>{ const arr=getCases(); const header=["Date","Start","End","Age","Sex","ASA","Procedure","Anesthetic","Airway","Case Type","Notes"]; const rows=arr.map(c=>[c.date,c.start,c.end,c.age,c.sex,c.asa,c.proc,c.anes,c.airway,c.caseType,c.notes]); const csv=[header].concat(rows).map(r=>r.map(v=>'"'+String(v||'').replace(/"/g,'""')+'"').join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cases.csv'; a.click(); URL.revokeObjectURL(url); });
const caseMask=$('caseMask'), caseBody=$('caseBody'); let currentId=null;
function viewHTML(c){ return `<div class="grid g-2"><div><b>Date:</b> ${c.date||''}</div><div><b>Time:</b> ${c.start||''}–${c.end||''} (${durationStr(c.start,c.end)})</div><div style="grid-column:1/-1"><b>Procedure:</b> ${c.proc||''}</div><div><b>Anesthetic:</b> ${c.anes||''}</div><div><b>ASA:</b> ${c.asa||''}</div><div><b>Age:</b> ${c.age||''}</div><div><b>Sex:</b> ${c.sex||''}</div><div><b>Case Type:</b> ${c.caseType||''}</div><div><b>Airway:</b> ${c.airway||''}</div><div style="grid-column:1/-1"><b>Notes:</b><br>${(c.notes||'').replace(/\n/g,'<br>')}</div></div>`; }
function editHTML(c){ return `<div class="grid g-2"><label>Date<input id="eDate" type="date" class="input" value="${c.date||''}"></label><label>Start<input id="eStart" type="time" class="input" value="${c.start||''}"></label><label>End<input id="eEnd" type="time" class="input" value="${c.end||''}"></label><label>Age<input id="eAge" type="number" class="input" value="${c.age||''}"></label><label>Sex<select id="eSex" class="input"><option></option><option>Male</option><option>Female</option><option>Other</option></select></label><label>Procedure<input id="eProc" class="input" value="${c.proc||''}"></label><label>Anesthetic<input id="eAnes" class="input" value="${c.anes||''}"></label><label>ASA<select id="eASA" class="input">
<option value=""></option>
<option value="I">ASA 1 — non-smoker / minimal alcohol use</option>
<option value="II">ASA 2 — smoker / pregnant / controlled HTN or DM</option>
<option value="III">ASA 3 — poorly controlled DM or HTN, BMI ≥ 40, > 3 mo MI/CVA</option>
<option value="IV">ASA 4 — < 3 mo MI/CVA, severe systemic disease</option>
<option value="V">ASA 5 — not expected to survive</option>
<option value="VI">ASA 6 — organ donor</option>
<option value="I-E">ASA 1-E — Emergency</option>
<option value="II-E">ASA 2-E — Emergency</option>
<option value="III-E">ASA 3-E — Emergency</option>
<option value="IV-E">ASA 4-E — Emergency</option>
<option value="V-E">ASA 5-E — Emergency</option>
</select></label><label>Case Type<input id="eType" class="input" value="${c.caseType||''}"></label><label>Airway<input id="eAirway" class="input" value="${c.airway||''}"></label><label style="grid-column:1/-1">Notes<textarea id="eNotes" class="input" rows="3">${c.notes||''}</textarea></label></div>`; }
document.getElementById('caseList').addEventListener('click', (e)=>{ const card=e.target.closest('.case-card'); if(!card) return; currentId=card.dataset.id; const c=getCases().find(x=>x.id===currentId); if(!c) return; caseBody.innerHTML=viewHTML(c); document.getElementById('caseEdit').style.display='inline-block'; document.getElementById('caseSave').style.display='none'; caseMask.classList.add('active'); });
document.getElementById('caseClose').addEventListener('click', ()=> caseMask.classList.remove('active'));
document.getElementById('caseDelete').addEventListener('click', ()=>{ if(!currentId) return; saveCases(getCases().filter(x=>x.id!==currentId)); renderCases(); caseMask.classList.remove('active'); });
document.getElementById('caseExport').addEventListener('click', ()=>{ if(!currentId) return; const c=getCases().find(x=>x.id===currentId); if(!c) return; const header=["Date","Start","End","Age","Sex","ASA","Procedure","Anesthetic","Airway","Case Type","Notes"]; const row=[c.date,c.start,c.end,c.age,c.sex,c.asa,c.proc,c.anes,c.airway,c.caseType,c.notes]; const csv=header.join(",")+"\n"+row.map(v=>'"'+String(v||'').replace(/"/g,'""')+'"').join(","); const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='case-'+(c.date||'entry')+'.csv'; a.click(); URL.revokeObjectURL(url); });
document.getElementById('caseEdit').addEventListener('click', ()=>{ const c=getCases().find(x=>x.id===currentId); if(!c) return; caseBody.innerHTML=editHTML(c); document.getElementById('eASA').value=c.asa||'';
 document.getElementById('eSex').value=c.sex||''; document.getElementById('caseEdit').style.display='none'; document.getElementById('caseSave').style.display='inline-block'; });
document.getElementById('caseSave').addEventListener('click', ()=>{ const arr=getCases(); const i=arr.findIndex(x=>x.id===currentId); if(i<0) return; const c=arr[i]; arr[i]={...c, date:document.getElementById('eDate').value, start:document.getElementById('eStart').value, end:document.getElementById('eEnd').value, age:document.getElementById('eAge').value, sex:document.getElementById('eSex').value, proc:document.getElementById('eProc').value, anes:document.getElementById('eAnes').value, asa:document.getElementById('eASA').value, caseType:document.getElementById('eType').value, airway:document.getElementById('eAirway').value, notes:document.getElementById('eNotes').value}; saveCases(arr); renderCases(); caseMask.classList.remove('active'); });
renderCases();

/* MEDICATIONS */
const DRUGS=[
  // Induction
  {cat:'Induction', name:'Propofol', brand:'Diprivan', unit:'mg/kg', range:[1,2.5],
   quick:{use:'IV induction and maintenance of anesthesia; also used for sedation and antiemesis in small doses.',
          onset:'30–45 sec', duration:'5–10 min (bolus)',
          ci:'Unstable hemodynamics without support; allergy to components.',
          ae:'Hypotension, respiratory depression, pain on injection; PRIS with prolonged high-dose infusions.',
          pearls:'Consider lidocaine 20–40 mg IV to reduce injection pain; reduce dose in elderly/hypovolemia.'},
   expanded:{cls:'Sedative-hypnotic', moa:'Potentiates GABA-A receptor activity.',
             pk:'Rapid onset from high lipid solubility; large Vd; hepatic + extrahepatic clearance.',
             excr:'Renal (metabolites).',
             tips:'Induction 1–2.5 mg/kg; maintenance 50–150 mcg/kg/min; monitor hemodynamics.'}},
  {cat:'Induction', name:'Etomidate', brand:'Amidate', unit:'mg/kg', range:[0.2,0.4],
   quick:{use:'Hemodynamically stable IV induction in fragile patients.', onset:'30–60 sec', duration:'3–10 min',
          ci:'Porphyria (relative).', ae:'Myoclonus, PONV, adrenal suppression with infusions.',
          pearls:'Consider opioid/benzodiazepine to blunt myoclonus.'},
   expanded:{cls:'Imidazole hypnotic', moa:'GABA-A modulation.',
             pk:'Rapid onset/short duration; minimal CV depression.', excr:'Hepatic/ester hydrolysis; renal excretion.',
             tips:'Induction 0.2–0.4 mg/kg; avoid prolonged infusions.'}},
  {cat:'Induction', name:'Lidocaine (IV)', brand:'Xylocaine', unit:'mg/kg', range:[1,1],
   quick:{use:'Blunts airway reflexes; adjunct analgesia; reduces propofol injection pain.',
          onset:'1–2 min', duration:'10–20 min', ci:'Severe heart block without pacer; allergy.',
          ae:'CNS toxicity at high levels; hypotension.', pearls:'Count toward total local-anesthetic load.'},
   expanded:{cls:'Amide local anesthetic', moa:'Na⁺ channel blockade.',
             pk:'Rapid onset IV.', excr:'Hepatic (CYP); renal metabolites.', tips:'1 mg/kg IV for airway blunting.'}},
  {cat:'Induction', name:'Ketamine', brand:'Ketalar', unit:'mg/kg', range:[1,2],
   quick:{use:'IV induction; analgesia at 0.2–0.5 mg/kg.', onset:'30–60 sec', duration:'5–15 min',
          ci:'Uncontrolled HTN/ischemia (relative).', ae:'Emergence delirium, sialorrhea, ↑HR/↑BP.',
          pearls:'Bronchodilator—useful in reactive airways.'},
   expanded:{cls:'PCP derivative', moa:'NMDA antagonism (dissociative).',
             pk:'High lipid solubility; hepatic to norketamine.', tips:'Consider glycopyrrolate for secretions.'}},

  // NMBD
  {cat:'NMBD', name:'Succinylcholine', brand:'Anectine', unit:'mg/kg', range:[1,1.5],
   quick:{use:'RSI paralysis (rapid onset/offset).', onset:'30–60 sec', duration:'5–10 min',
          ci:'Burns >24–48h, neuromuscular disease, hyperkalemia risk, MH.', ae:'Bradycardia (repeat), hyperkalemia, fasciculations.',
          pearls:'Avoid in denervation/chronic paralysis.'},
   expanded:{cls:'Depolarizing NMBD', moa:'Nicotinic agonist causing depolarization.', tips:'Consider atropine in peds.'}},
  {cat:'NMBD', name:'Rocuronium', brand:'Zemuron', unit:'mg/kg', range:[0.6,1.2],
   quick:{use:'Intubation paralysis; RSI at 1.2 mg/kg.', onset:'60–90 sec (1.2 mg/kg)', duration:'30–60 min',
          ci:'Hypersensitivity', ae:'Rare anaphylaxis', pearls:'Sugammadex reversal 2–16 mg/kg.'},
   expanded:{cls:'NDMB (aminosteroid)', moa:'Competitive nicotinic antagonist.', tips:'Volatiles potentiate block.'}},

  // Opioids
  {cat:'Opioid', name:'Fentanyl', brand:'Sublimaze', unit:'mcg/kg', range:[1,2],
   quick:{use:'Analgesia, blunts sympathetic response.', onset:'2–3 min', duration:'30–60 min',
          ci:'Hypersensitivity', ae:'Resp depression, chest wall rigidity (rapid/high doses).',
          pearls:'25–50 mcg aliquots.'},
   expanded:{cls:'Phenylpiperidine', moa:'μ-agonist.', tips:'Beware serotonergic interactions/MAOIs.'}},
  {cat:'Opioid', name:'Remifentanil', brand:'Ultiva', unit:'mcg/kg/min', range:[0.05,2],
   quick:{use:'Short-acting analgesia/suppression.', onset:'1–2 min', duration:'3–5 min (context-insensitive)',
          ci:'Hypersensitivity', ae:'Bradycardia, hypotension, apnea.', pearls:'Bridge with longer-acting opioid before stop.'},
   expanded:{cls:'Ester opioid', moa:'μ-agonist', tips:'Organ-independent clearance (esterases).'}},
  {cat:'Opioid', name:'Hydromorphone', brand:'Dilaudid', unit:'mcg/kg', range:[15,15],
   quick:{use:'Longer-acting analgesia.', onset:'5–10 min', duration:'3–5 h',
          ci:'Hypersensitivity', ae:'Resp depression, pruritus, nausea.', pearls:'Typical 0.2–0.6 mg IV titration.'},
   expanded:{cls:'Semi-synthetic opioid', moa:'μ-agonist', tips:'Renal caution (H3G metabolite).'}},

  // Reversal
  {cat:'Reversal', name:'Naloxone', brand:'Narcan', unit:'mcg/kg', range:[1,10],
   quick:{use:'Opioid reversal.', onset:'1–2 min', duration:'30–60 min',
          ci:'Opioid dependence (withdrawal).', ae:'Pain, hypertension, pulmonary edema (rare).',
          pearls:'Titrate 20–40 mcg aliquots; consider infusion.'},
   expanded:{cls:'Opioid antagonist', moa:'Competitive μ blockade.', tips:'Watch for renarcotization.'}},
  {cat:'Reversal', name:'Neostigmine', brand:'Bloxiverz', unit:'mcg/kg', range:[25,75],
   quick:{use:'NDMB reversal (with antimuscarinic).', onset:'7–11 min', duration:'45–60 min',
          ci:'GI/GU obstruction.', ae:'Bradycardia, bronchospasm, secretions.', pearls:'Pair glycopyrrolate 10–20 mcg/kg.'},
   expanded:{cls:'AChE inhibitor', moa:'↑ACh at NMJ.', tips:'Requires adequate TOF.'}},
  {cat:'Reversal', name:'Sugammadex', brand:'Bridion', unit:'mg/kg', range:[2,16],
   quick:{use:'Roc/Vec reversal.', onset:'2–3 min (2–4 mg/kg); immediate at 16 mg/kg',
          ci:'Severe renal impairment (relative).', ae:'Bradycardia, anaphylaxis (rare).',
          pearls:'2 mg/kg (TOF 2+), 4 mg/kg (deep), 16 mg/kg for RSI dose.'},
   expanded:{cls:'Cyclodextrin chelator', moa:'Encapsulates roc/vec.', tips:'Warn about hormonal contraceptive interaction (backup 7 days).'}},
  {cat:'Reversal', name:'Glycopyrrolate', brand:'Robinul', unit:'mcg/kg', range:[10,20],
   quick:{use:'Counter muscarinic effects; antisialagogue.', onset:'1–2 min', duration:'2–4 h',
          ci:'Glaucoma caution, GI obstruction.', ae:'Tachycardia, dry mouth, urinary retention.', pearls:'Does not cross BBB.'},
   expanded:{cls:'Antimuscarinic (quaternary)', moa:'M3 antagonism.', tips:'0.2 mg per 1 mg neostigmine (approx).'}},
  {cat:'Reversal', name:'Atropine', brand:'Atropen', unit:'mcg/kg', range:[10,20],
   quick:{use:'Bradycardia (adult); antimuscarinic adjunct (peds).', onset:'1–2 min', duration:'1–2 h',
          ci:'Glaucoma, tachyarrhythmias.', ae:'Tachycardia, CNS effects.', pearls:'Crosses BBB.'},
   expanded:{cls:'Antimuscarinic (tertiary)', moa:'Muscarinic antagonism.', tips:'Consider glyco in adults with neostigmine.'}},

  // Rescue
  {cat:'Rescue', name:'Phenylephrine', brand:'Neo-Synephrine', unit:'mcg/kg', range:[1,2], fixed:'50–100 mcg IV',
   quick:{use:'Vasoplegia/post-induction hypotension.', onset:'<1 min', duration:'5–10 min',
          ci:'Severe bradyarrhythmias.', ae:'Reflex bradycardia, ↓CO.', pearls:'Pure α1; consider ephedrine if bradycardic.'},
   expanded:{cls:'α1-agonist', moa:'Peripheral vasoconstriction.', tips:'Infusion 0.1–1 mcg/kg/min.'}},
  {cat:'Rescue', name:'Ephedrine', brand:'—', unit:'mg', range:[5,10],
   quick:{use:'Hypotension with low HR.', onset:'<1 min', duration:'10–15 min',
          ci:'Tachyarrhythmias.', ae:'Tachycardia, hypertension.', pearls:'Tachyphylaxis with repeated doses.'},
   expanded:{cls:'Indirect sympathomimetic', moa:'NE release; α/β agonism.', tips:'Use direct agent if catecholamine depleted.'}},
  {cat:'Rescue', name:'Norepinephrine', brand:'Levophed', unit:'mcg/min', range:[2,20],
   quick:{use:'Vasoplegic shock.', onset:'<1 min', duration:'1–2 min (infusion)',
          ci:'Ischemia risk; extravasation.', ae:'Arrhythmias, ischemia.', pearls:'α1>β1—↑SVR with modest inotropy.'},
   expanded:{cls:'Catecholamine', moa:'α1/β1 agonism.', tips:'Prefer central line for higher doses.'}},
  {cat:'Rescue', name:'Vasopressin', brand:'Vasostrict', unit:'units/min', range:[0.01,0.04],
   quick:{use:'Refractory vasoplegia (esp. ACE-I).', onset:'5–15 min', duration:'10–20 min',
          ci:'Ischemic risk at high doses.', ae:'Hyponatremia, ischemia.', pearls:'No effect on HR/CO (pure V1).'},
   expanded:{cls:'Peptide analog', moa:'V1 receptor agonist.', tips:'Adjunct to NE.'}},
  {cat:'Rescue', name:'Esmolol', brand:'Brevibloc', unit:'mg', range:[10,30],
   quick:{use:'Blunt tachycardia/HTN.', onset:'1–2 min', duration:'10–20 min',
          ci:'Severe bradycardia, heart block.', ae:'Hypotension, bradycardia.', pearls:'Ultra–short acting β1 selective.'},
   expanded:{cls:'β1-blocker', moa:'β1 antagonism.', tips:'RBC esterase metabolism.'}},
  {cat:'Rescue', name:'Hydralazine', brand:'Apresoline', unit:'mg', range:[2.5,20],
   quick:{use:'Afterload reduction/HTN.', onset:'10–20 min', duration:'3–8 h',
          ci:'Tachycardia/angina.', ae:'Reflex tachycardia, headache.', pearls:'Slow onset—use when time allows.'},
   expanded:{cls:'Direct arterial vasodilator', moa:'Smooth muscle relaxation.', tips:'Start 2.5–5 mg.'}},

  // Adjuncts
  {cat:'Adjunct', name:'Midazolam', brand:'Versed', unit:'mg', range:[1,2],
   quick:{use:'Anxiolysis/amnesia.', onset:'2–3 min', duration:'30–60 min',
          ci:'Severe respiratory depression risk.', ae:'Respiratory depression (with opioids).', pearls:'Small doses 1–2 mg; caution elderly/OSA.'},
   expanded:{cls:'Benzodiazepine', moa:'GABA-A modulation.', tips:'CYP3A4 metabolism.'}},
  {cat:'Adjunct', name:'Dexmedetomidine', brand:'Precedex', unit:'mcg/kg', range:[0.2,1],
   quick:{use:'Sedation with minimal respiratory depression.', onset:'10–15 min', duration:'Dose-dependent',
          ci:'Bradycardia/hypotension.', ae:'Bradycardia, hypotension.', pearls:'Avoid bolus in fragile patients.'},
   expanded:{cls:'α2-agonist', moa:'Locus coeruleus α2 stimulation.', tips:'Infusion 0.2–0.7 mcg/kg/hr typical.'}},
  {cat:'Adjunct', name:'Dexamethasone', brand:'Decadron', unit:'mg', range:[4,10],
   quick:{use:'PONV prophylaxis; anti-inflammatory.', onset:'1–2 h', duration:'24–72 h',
          ci:'Uncontrolled diabetes (glucose rise).', ae:'Hyperglycemia, mood changes.', pearls:'Give after induction.'},
   expanded:{cls:'Glucocorticoid', moa:'Genomic anti-inflammatory.', tips:'4–8 mg common.'}},
  {cat:'Adjunct', name:'Ondansetron', brand:'Zofran', unit:'mg', range:[4,8],
   quick:{use:'Antiemetic.', onset:'10–30 min', duration:'4–8 h',
          ci:'QT prolongation risk.', ae:'Headache, constipation, QT prolongation.', pearls:'4 mg IV near end of case.'},
   expanded:{cls:'5-HT3 antagonist', moa:'Blocks 5-HT3 in CTZ/vagal afferents.', tips:'Adjust if severe hepatic impairment.'}},
  {cat:'Adjunct', name:'Haloperidol', brand:'Haldol', unit:'mg', range:[1,2],
   quick:{use:'Antiemetic/delirium adjunct.', onset:'10–20 min', duration:'4–6 h',
          ci:'Parkinson’s disease, QT prolongation.', ae:'QT prolongation, EPS (rare single low dose).', pearls:'0.5–1 mg IV useful.'},
   expanded:{cls:'Butyrophenone', moa:'D2 antagonism.', tips:'Monitor QT in high-risk.'}},
  {cat:'Adjunct', name:'Ketorolac', brand:'Toradol', unit:'mg', range:[15,30],
   quick:{use:'NSAID analgesia.', onset:'10–15 min', duration:'4–6 h',
          ci:'Renal failure, GI bleed risk, pregnancy near term.', ae:'Bleeding, renal injury.', pearls:'Reduce dose in elderly/renal impairment.'},
   expanded:{cls:'NSAID', moa:'COX inhibition.', tips:'Consider platelet effects for neuraxial timing.'}}
];

/* DRUGS ENRICHMENT */
try {
  const EXCR_MAP = {"Propofol": "Hepatic conjugation + extrahepatic clearance; inactive metabolites renally excreted.", "Etomidate": "Ester hydrolysis by hepatic/plasma esterases; renal excretion of metabolites.", "Lidocaine (IV)": "Hepatic CYP1A2/3A4 to active and inactive metabolites; renal excretion.", "Ketamine": "Hepatic CYP3A4/2B6/2C9 to norketamine; renal excretion.", "Succinylcholine": "Rapid hydrolysis by plasma pseudocholinesterase (butyrylcholinesterase); minimal renal excretion.", "Rocuronium": "Hepatic uptake/biliary excretion (primary) with ~10–20% renal excretion.", "Fentanyl": "Hepatic CYP3A4 metabolism; inactive metabolites renally excreted.", "Remifentanil": "Rapid hydrolysis by non-specific blood/tissue esterases; organ-independent; renal excretion of metabolites.", "Hydromorphone": "Hepatic glucuronidation to H3G; renal excretion (accumulates in renal impairment).", "Naloxone": "Hepatic glucuronidation; renal excretion; short half-life.", "Neostigmine": "Hepatic metabolism; predominant renal excretion (dose-reduce in renal impairment).", "Sugammadex": "Renally excreted unchanged; avoid in severe renal impairment.", "Glycopyrrolate": "Renal excretion (major) with some hepatic metabolism; quaternary—does not cross BBB.", "Atropine": "Hepatic metabolism; renal excretion; tertiary amine—crosses BBB.", "Phenylephrine": "Metabolized by MAO; renal excretion of metabolites.", "Ephedrine": "Partial hepatic metabolism; largely renally excreted unchanged; urinary pH–dependent.", "Norepinephrine": "Uptake/metabolism by MAO and COMT; metabolites renally excreted.", "Vasopressin": "Hepatic and renal metabolism; V1 receptor-mediated clearance.", "Esmolol": "Rapid hydrolysis by RBC esterases; renal excretion of metabolites.", "Hydralazine": "Hepatic acetylation; renal excretion of metabolites.", "Midazolam": "Hepatic CYP3A4 to 1‑OH‑midazolam; renal excretion (active metabolite).", "Dexmedetomidine": "Hepatic glucuronidation and CYP2A6; renal excretion of metabolites.", "Dexamethasone": "Hepatic metabolism; renal excretion.", "Ondansetron": "Hepatic CYP3A4/2D6/1A2; renal excretion; prolongs QT at high doses.", "Haloperidol": "Hepatic metabolism (CYP3A4/2D6); renal/biliary excretion.", "Ketorolac": "Hepatic metabolism; predominantly renal excretion (dose-reduce renally)."};
  DRUGS.forEach(d => {
    d.expanded = d.expanded || {};
    const q = d.quick || {};
    // Onset/Duration (fallbacks from quick)
    if (!d.expanded.onset && q.onset) d.expanded.onset = q.onset;
    if (!d.expanded.duration && q.duration) d.expanded.duration = q.duration;
    // Uses (fallback from quick.use)
    if (!d.expanded.uses && q.use) d.expanded.uses = q.use;
    // Contraindications/Adverse effects (fallbacks)
    if (!d.expanded.ci && q.ci) d.expanded.ci = q.ci;
    if (!d.expanded.ae && q.ae) d.expanded.ae = q.ae;
    // Dose string from range/unit/fixed
    if (!d.expanded.dose) {
      const r = d.range || [];
      const lo = r[0], hi = r[1];
      const unit = (d.unit || '');
      let doseStr = '';
      if (typeof lo === 'number' && typeof hi === 'number') {
        if (lo === hi) doseStr = `${lo} ${unit}`;
        else doseStr = `${lo}–${hi} ${unit}`;
      }
      if (d.fixed) doseStr += (doseStr ? ' • ' : '') + `Fixed: ${d.fixed}`;
      d.expanded.dose = doseStr;
    }
    // Excretion/Metabolism mapping
    if (!d.expanded.excr && EXCR_MAP[d.name]) d.expanded.excr = EXCR_MAP[d.name];
  });
} catch(e) { console.error(e); }

const ORDER=['Induction','NMBD','Opioid','Reversal','Rescue','Adjunct'];
const medList = document.getElementById('medList');
function doseBadge(w, d){ if(!w || !d.range) return ''; const [lo,hi]=d.range; const unit=d.unit||''; const labelUnit=unit.replace('/kg','').replace('/kg/min','/min'); let txt=''; if(lo===hi){ txt=(lo*w).toFixed(1)+' '+labelUnit; } else { txt=(lo*w).toFixed(1)+'–'+(hi*w).toFixed(1)+' '+labelUnit; } if(d.fixed) txt+=' (or '+d.fixed+')'; return '<span class="badge badge-accent" style="margin-left:6px">'+txt+'</span>'; }
function renderMeds(){ const w = parseFloat(document.getElementById('ptWt').value||'0'); const search = (document.getElementById('searchDrug').value||'').toLowerCase(); medList.innerHTML=''; ORDER.forEach(cat=>{ const items = DRUGS.filter(d=>d.cat===cat && (d.name.toLowerCase().includes(search) || d.brand.toLowerCase().includes(search))); if(!items.length) return; const block=document.createElement('div'); block.className='ghost'; const head=document.createElement('div'); head.className='cat-header'; head.innerHTML = `<div>${cat}</div><div class="small">${items.length} drugs</div>`; block.appendChild(head); items.forEach(d=>{ const row=document.createElement('div'); row.className='drug-row'; const left=document.createElement('div'); left.innerHTML = `<div style="font-weight:800">${d.name} <span class="small">(${d.brand})</span></div><div class="dose-base">${d.unit} ${d.range[0]}–${d.range[1]}${d.fixed? ' • Fixed: '+d.fixed:''}</div>`; const right=document.createElement('div'); right.innerHTML = `<span class="small">Dose for ${w>0?w+' kg':'—'}</span>${doseBadge(w,d)} <button class="btn" data-info="${d.name}">Info</button>`; row.appendChild(left); row.appendChild(right); block.appendChild(row); }); medList.appendChild(block); }); }
document.getElementById('ptWt').addEventListener('input', renderMeds);
document.getElementById('searchDrug').addEventListener('input', renderMeds);
renderMeds();
/* Drug Modal */
const drugMask=document.getElementById('drugMask'); const drugTitle=document.getElementById('drugTitle'); const drugBody=document.getElementById('drugBody'); let drugTab='quick';
function quickHTML(d){ const q=d.quick||{}; return `<div><p><b>Use:</b> ${q.use||''}</p><p><b>Onset:</b> ${q.onset||''} &nbsp;&nbsp; <b>Duration:</b> ${q.duration||''}</p><p><b>Contraindications:</b> ${q.ci||''}</p><p><b>Adverse Effects:</b> ${q.ae||''}</p><p><b>Clinical Pearls:</b> ${q.pearls||''}</p></div>`; }

function expandedHTML(d){
  const e = d.expanded || {};
  return `
    <div class="small">
      <p><b>Class:</b> ${e.cls||''}</p>
      <p><b>MOA:</b> ${e.moa||''}</p>
      <p><b>Onset:</b> ${e.onset||''}</p>
      <p><b>Duration:</b> ${e.duration||''}</p>
      <p><b>Common Dosages:</b> ${e.dose||''}</p>
      <p><b>Uses:</b> ${e.uses||''}</p>
      <p><b>Adverse Effects:</b> ${e.ae||''}</p>
      <p><b>Excretion/Metabolism:</b> ${e.excr||''}</p>
      <p><b>Contraindications:</b> ${e.ci||''}</p>
      <p><b>Clinical Pearls:</b> ${e.tips||''}</p>
    </div>`;
}
function renderDrug(name){ const d = DRUGS.find(x=>x.name===name); if(!d){ drugBody.innerHTML='<div class="small">Info coming soon.</div>'; return; } drugBody.innerHTML = (drugTab==='quick') ? quickHTML(d) : expandedHTML(d); }
document.getElementById('medList').addEventListener('click', (e)=>{ const btn = e.target.closest('button[data-info]'); if(!btn) return; const name = btn.getAttribute('data-info'); drugTitle.textContent=name; drugTab='quick'; renderDrug(name); drugMask.classList.add('active'); document.getElementById('drugTabQuick').onclick=()=>{ drugTab='quick'; renderDrug(name); }; document.getElementById('drugTabExpanded').onclick=()=>{ drugTab='expanded'; renderDrug(name); }; });
document.getElementById('drugClose').addEventListener('click', ()=>drugMask.classList.remove('active'));
/* CALCULATORS */
function calcAll(){ const h = parseFloat(($('hCm').value)||'0'); const w = parseFloat(($('wKg').value)||'0'); const sex=$('pSex').value||'Male'; const ibw = sex==='Male' ? (50 + 0.9*(h-152)) : (45.5 + 0.9*(h-152)); const bmi = h>0 ? (w / ((h/100)**2)) : 0; const ebv = (sex==='Male'?75:65) * (w>0?w:0); const tv = 7 * (w>0?w:0); const ett = sex==='Male' ? '7.5–8.0' : '7.0–7.5'; const lma = w<50?'#3':(w<70?'#4':'#5'); const glance=[['IBW (kg)', ibw>0?ibw.toFixed(1):'—'],['BMI', bmi>0?bmi.toFixed(1):'—'],['EBV (mL)', ebv>0?Math.round(ebv):'—'],['Tidal Volume (mL)', tv>0?Math.round(tv):'—'],['ETT Size', ett],['LMA Size', lma]]; const at=$('atGlance'); at.innerHTML=''; glance.forEach(([k,v])=>{ const div=document.createElement('div'); div.innerHTML = `<b>${k}:</b> <span class="hl">${v}</span>`; at.appendChild(div); }); const hs=parseFloat(($('hctStart').value)||'0'); const ht=parseFloat(($('hctTarget').value)||'0'); if(w>0 && hs>0 && ht>0){ const ebvCalc=(sex==='Male'?75:65)*w; const abl = ebvCalc * (hs - ht) / hs; $('ablOut').textContent = isFinite(abl)? Math.round(abl) + ' mL' : '—'; } else $('ablOut').textContent='—'; const npo=parseFloat(($('npoH').value)||'0'); if(w>0){ let rate=0; if (w <= 10) rate = w*4; else if (w <= 20) rate = 40 + (w-10)*2; else rate = 60 + (w-20)*1; $('mivfOut').textContent = Math.round(rate) + ' mL/hr'; $('defOut').textContent = Math.round(rate*(npo>0?npo:0)) + ' mL'; } else { $('mivfOut').textContent='—'; $('defOut').textContent='—'; } const d=$('laDrug').value, conc=parseFloat(($('laConc').value)||'0'), epi=$('laEpi').value; if(w>0 && d && conc>0){ const caps={ lidocaine:{plain:4.5, epi:7}, bupivacaine:{plain:2.5, epi:3}, ropivacaine:{plain:3, epi:3}, mepivacaine:{plain:5, epi:7} }; const mgkg = (epi==='yes'? caps[d].epi : caps[d].plain); const maxDose = mgkg * w; const mgPerMl = conc*10; const maxVol = maxDose / mgPerMl; $('laMaxDose').textContent = maxDose.toFixed(1)+' mg ('+mgkg+' mg/kg)'; $('laMaxVol').textContent = maxVol.toFixed(1)+' mL @ '+conc+'%'; } else { $('laMaxDose').textContent='—'; $('laMaxVol').textContent='—'; } 
// BEGIN SURGICAL FLUIDS
if ($('surgCase')) {
  const sel = $('surgCase').value;
  const weight = w; // from earlier
  const ruleEl = $('surgRuleOut');
  const outEl = $('surgFluidOut');
  const burnsBox = $('burnsBox');
  const burnPct = $('burnPct') ? parseFloat(($('burnPct').value)||'0') : 0;

  let ruleTxt = '—', calcTxt = '—';

  if (sel === 'parkland') {
    burnsBox.style.display = 'block';
    ruleTxt = 'Parkland: 4 ml/kg/%TBSA (24h, 1/2 in first 8h)';
    if (weight > 0 && burnPct > 0) {
      const vol = 4 * weight * burnPct;
      calcTxt = `${Math.round(vol)} mL (first 24h)`;
    }
  } else {
    burnsBox.style.display = 'none';
    if (sel && weight > 0) {
      const parts = sel.split('-');
      if (parts.length === 2) {
        const lo = parseFloat(parts[0]), hi = parseFloat(parts[1]);
        const loRate = lo * weight;
        const hiRate = hi * weight;
        // Map back to label for visibility
        let label = '';
        if (sel === '2-4') label = 'Minimally invasive (laparoscopic): 2–4 ml/kg/hr';
        else if (sel === '4-6') label = 'Moderate tissue trauma: 4–6 ml/kg/hr';
        else if (sel === '6-8') label = 'Major open (e.g., open abdomen): 6–8 ml/kg/hr';
        ruleTxt = label;
        calcTxt = `${Math.round(loRate)}–${Math.round(hiRate)} mL/hr (for ${weight.toFixed(1)} kg)`;
      }
    }
  }
  if (ruleEl) ruleEl.textContent = ruleTxt;
  if (outEl) outEl.textContent = calcTxt;
} else {
  // Elements not present on this tab
}
// END SURGICAL FLUIDS
}
['hCm','wKg','pSex','hctStart','hctTarget','npoH','laDrug','laConc','laEpi'].forEach(id=>$(id).addEventListener('input', calcAll));
calcAll();
if ($('surgCase')) $('surgCase').addEventListener('change', calcAll);
if ($('burnPct')) $('burnPct').addEventListener('input', calcAll);


/* PEARLS EXPAND/COLLAPSE */
$('btnExpandPearls').addEventListener('click', ()=>{ document.querySelectorAll('#tab-pearls details').forEach(d=>d.open=true); });
$('btnCollapsePearls').addEventListener('click', ()=>{ document.querySelectorAll('#tab-pearls details').forEach(d=>d.open=false); });

/* ==== LOCAL ANESTHETIC RUNNING TOTALS (Add Agent feature, enhanced) ==== */
const LA_KEY='srna_la_log_v3';
const getLA=()=>{ try{return JSON.parse(localStorage.getItem(LA_KEY)||'[]');}catch(e){return [];} };
const saveLA=arr=>localStorage.setItem(LA_KEY, JSON.stringify(arr));
const LA_CAPS = { lidocaine:{plain:4.5, epi:7}, bupivacaine:{plain:2.5, epi:3}, ropivacaine:{plain:3, epi:3}, mepivacaine:{plain:5, epi:7} };
function mgPerMlFromConc(conc){ return conc*10; } // 1% = 10 mg/mL

function totalsByAgent(){
  const t = {lidocaine:0, bupivacaine:0, ropivacaine:0, mepivacaine:0};
  getLA().forEach(a => { if (t.hasOwnProperty(a.drug)) t[a.drug] += a.mg; });
  return t;
}
function compositeFraction(){
  const w=parseFloat((document.getElementById('wKg')?.value)||'0');
  if(!(w>0)) return 0;
  let sum=0;
  getLA().forEach(a => {
    const perKg=(a.epi==='yes'?LA_CAPS[a.drug].epi:LA_CAPS[a.drug].plain);
    const max = perKg * w;
    if(max>0) sum += a.mg / max;
  });
  return sum;
}
function remainingForSelected(){
  const drug = document.getElementById('laDrug')?.value;
  const conc = parseFloat((document.getElementById('laConc')?.value)||'0');
  const epi  = document.getElementById('laEpi')?.value || 'no';
  const w    = parseFloat((document.getElementById('wKg')?.value)||'0');
  if(!drug || !(w>0) || !(conc>0)) return {mg:0, ml:0, maxMg:0, givenMg:0};
  const perKg=(epi==='yes'?LA_CAPS[drug].epi:LA_CAPS[drug].plain);
  const agentMax = perKg * w;
  const byAgent = totalsByAgent();
  const given = byAgent[drug] || 0;
  const compFrac = compositeFraction();
  const compRemaining = Math.max(0, (1 - compFrac) * agentMax);
  const agentRemaining = Math.max(0, agentMax - given);
  const mgAllowed = Math.min(compRemaining, agentRemaining);
  const mlAllowed = mgPerMlFromConc(conc)>0 ? (mgAllowed / mgPerMlFromConc(conc)) : 0;
  return {mg:mgAllowed, ml:mlAllowed, maxMg:agentMax, givenMg:given};
}
function updateRemainingBadges(){
  const rem = remainingForSelected();
  const rMg = document.getElementById('laRemainMg');
  const rMl = document.getElementById('laRemainMl');
  if(rMg) rMg.textContent = (rem.mg>0 ? rem.mg.toFixed(1) : '0.0') + ' mg';
  if(rMl) rMl.textContent = (rem.ml>0 ? rem.ml.toFixed(1) : '0.0') + ' mL';
}
function renderLARows(){
  const tbody=document.getElementById('laTbody');
  const totalsEl=document.getElementById('laTotals');
  if(!tbody||!totalsEl) return;
  const w=parseFloat((document.getElementById('wKg')?.value)||'0');
  const list=getLA();
  if(!list.length){
    tbody.innerHTML='<tr><td colspan="8" class="small" style="border:1px solid var(--border);padding:8px;color:var(--muted-2)">No agents added yet.</td></tr>';
    
totalsEl.innerHTML = 'Total Given: '
  + '<span class="badge '+(dangerAll?'':'badge-soft')+'"'
  + ' style="'+(dangerAll?'background:var(--danger);color:#fff':'')+'">'
  + sumMg.toFixed(1) + ' mg</span>'
  + ' <span class="small muted">('
  + '<span id="laTotalGivenPct" class="badge '+(dangerAll?'':'badge-soft')+'"'
  + ' style="'+(dangerAll?'background:var(--danger);color:#fff':'background:#4caf50;color:#fff;border-color:#4caf50')+'">'
  + overallPct + '%</span>)</span>'
  + ' &nbsp; • &nbsp; Composite use: '
  + '<span class="badge '+(dangerAll?'':'badge-soft')+'" style="'+(dangerAll?'background:var(--danger);color:#fff':'')+'">'
  + overallPct + '%</span>';

    updateRemainingBadges();
    return;
  }
  let rows=''; let sumMg=0; let sumFraction=0;
  list.forEach((a,i)=>{
    const perKg=(a.epi==='yes'?LA_CAPS[a.drug].epi:LA_CAPS[a.drug].plain);
    const agentMaxMg=(w>0?perKg*w:0);
    const frac=agentMaxMg>0?(a.mg/agentMaxMg):0;
    sumMg+=a.mg; sumFraction+=frac;
    const pctTxt=agentMaxMg>0? (100*frac).toFixed(0)+'%':'—';
    const danger = frac>1;
    rows += '<tr>'
      + '<td style="border:1px solid var(--border);padding:6px">'+a.drug+'</td>'
      + '<td style="border:1px solid var(--border);padding:6px">'+a.conc+'%</td>'
      + '<td style="border:1px solid var(--border);padding:6px">'+(a.epi==='yes'?'Yes':'No')+'</td>'
      + '<td style="border:1px solid var(--border);padding:6px">'+(a.vol>0?a.vol.toFixed(1):'—')+'</td>'
      + '<td style="border:1px solid var(--border);padding:6px">'+a.mg.toFixed(1)+'</td>'
      + '<td style="border:1px solid var(--border);padding:6px">'+(agentMaxMg>0?agentMaxMg.toFixed(1):'—')+'</td>'
      + '<td style="border:1px solid var(--border);padding:6px;'+(danger?'color:var(--danger);font-weight:800':'')+'">'+pctTxt+'</td>'
      + '<td style="border:1px solid var(--border);padding:6px"><button class="btn btn-danger" data-del="'+i+'">Delete</button></td>'
      + '</tr>';
  });
  tbody.innerHTML=rows;
  const overallPct=(100*sumFraction).toFixed(0);
  const dangerAll=sumFraction>1;
  totalsEl.innerHTML = 'Total given: <span class="badge '+(dangerAll?'':'badge-soft')+'" style="'+(dangerAll?'background:var(--danger);color:#fff':'')+'">'+sumMg.toFixed(1)+' mg</span>'
    + ' &nbsp; • &nbsp; Composite use: '
    + '<span class="badge '+(dangerAll?'':'badge-soft')+'" style="'+(dangerAll?'background:var(--danger);color:#fff':'')+'">'+overallPct+'%</span>';
  if(dangerAll){
    totalsEl.insertAdjacentHTML('beforeend',' <span class="badge" style="background:var(--warn);color:#000;margin-left:8px">Over safe amount!</span>');
  }
  updateRemainingBadges();
}
function addLAFromUI(e){
  if (e) e.preventDefault();
  const drug=document.getElementById('laDrug')?.value;
  const conc=parseFloat((document.getElementById('laConc')?.value)||'0');
  const epi=document.getElementById('laEpi')?.value||'no';
  const unit=document.getElementById('laDoseUnit')?.value||'mL';
  const valEl=document.getElementById('laVolGiven');
  const doseVal=parseFloat((valEl?.value)||'0');
  const w=parseFloat((document.getElementById('wKg')?.value)||'0');
  if(!drug || !(conc>0) || !(doseVal>0) || !(w>0)) return;
  const rem = remainingForSelected();
  const mgMl=mgPerMlFromConc(conc);
  let addMg = unit==='mL' ? (mgMl * doseVal) : doseVal;
  if(addMg > rem.mg + 1e-6){ addMg = rem.mg; }
  const vol = mgMl>0 ? (addMg / mgMl) : 0;
  const list=getLA(); list.push({drug,conc,epi,vol,mg:addMg}); saveLA(list);
  if(valEl) valEl.value='';
  renderLARows();
}
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('button[data-del]'); if(!btn) return;
  const idx=parseInt(btn.getAttribute('data-del'),10);
  const list=getLA(); if(idx>=0 && idx<list.length){ list.splice(idx,1); saveLA(list); renderLARows(); }
});
(function wireLA(){
  const add=document.getElementById('laAdd'); if(add) add.addEventListener('click', addLAFromUI);
  const addEnter = document.getElementById('laVolGiven');
  if(addEnter){
    addEnter.addEventListener('keydown', (ev)=>{
      if(ev.key==='Enter'){ ev.preventDefault(); addLAFromUI(ev); }
    });
  }
  const clr=document.getElementById('laClear'); if(clr) clr.addEventListener('click', ()=>{ saveLA([]); renderLARows(); });
  const unit=document.getElementById('laDoseUnit');
  if(unit){
    unit.addEventListener('change', ()=>{
      const input=document.getElementById('laVolGiven');
      if(input) input.placeholder = unit.value==='mL' ? 'e.g., 20' : 'e.g., 100 (mg)';
      const lbl = input ? input.closest('label') : null;
      if(lbl && lbl.firstChild && lbl.firstChild.nodeType===3){
        lbl.firstChild.textContent = unit.value==='mL' ? 'Dose Given/Planned (mL)' : 'Dose Given/Planned (mg)';
      }
      updateRemainingBadges();
    });
  }
  ['wKg','laDrug','laConc','laEpi'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', ()=>{ renderLARows(); updateRemainingBadges(); }); });
  const autoBtn = document.getElementById('laAutoFill');
  if(autoBtn){
    autoBtn.addEventListener('click', ()=>{
      const unitSel=document.getElementById('laDoseUnit');
      const input=document.getElementById('laVolGiven');
      const rem = remainingForSelected();
      if(!unitSel || !input) return;
      if(unitSel.value==='mL'){ input.value = rem.ml>0? rem.ml.toFixed(1) : 0; }
      else { input.value = rem.mg>0? rem.mg.toFixed(1) : 0; }
    });
  }
  renderLARows();
  updateRemainingBadges();
})();
/* ==== END LA RUNNING TOTALS ==== */

/* ==== Color coding helpers for running totals ==== */
function statusColor(pct){ // pct is 0-100
  if (!(pct>=0)) return {bg:'', fg:''};
  if (pct < 70) return {bg:'var(--success)', fg:'#fff'};        // green
  if (pct < 90) return {bg:'var(--warn)', fg:'#000'};           // yellow
  return {bg:'var(--danger)', fg:'#fff'};                       // red
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const hInput = document.getElementById('hCm');
  const uSel = document.getElementById('hUnit');
  const toIn = cm => cm/2.54;
  const toCm = inch => inch*2.54;
  function updatePlaceholder(){
    if(!hInput||!uSel) return;
    hInput.placeholder = uSel.value==='cm' ? 'e.g., 170' : 'e.g., 67';
  }
  function convertValue(oldUnit,newUnit){
    if(!hInput) return;
    const v = parseFloat(hInput.value);
    if(!(v>=0)) return;
    if(oldUnit==='cm'&&newUnit==='in'){ hInput.value = (toIn(v)).toFixed(1); }
    if(oldUnit==='in'&&newUnit==='cm'){ hInput.value = (toCm(v)).toFixed(1); }
  }
  if(hInput && uSel){
    updatePlaceholder();
    uSel.addEventListener('change', (e)=>{
      convertValue(e.target._prev || 'cm', e.target.value);
      e.target._prev = e.target.value;
      updatePlaceholder();
      if (typeof window.recalcCalcs==='function') try{ window.recalcCalcs(); }catch(_){}
    });
    uSel._prev = uSel.value;
  }
  window.getHeightCm = function(){
    if(!hInput||!uSel) return null;
    const raw = parseFloat(hInput.value);
    if(!(raw>=0)) return null;
    return uSel.value==='cm' ? raw : (raw*2.54);
  };
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  function mark(el, hasVal){
    if(!el) return;
    el.classList.remove('badge-soft');
    if(hasVal){ el.style.background='var(--accent)'; el.style.color='#fff'; }
    else { el.style.background=''; el.style.color=''; el.classList.add('badge-soft'); }
  }
  const rate = document.getElementById('mivfOut');
  const def = document.getElementById('defOut');
  function refresh(){
    if(rate) mark(rate, /\d/.test(rate.textContent));
    if(def) mark(def, /\d/.test(def.textContent));
  }
  refresh();
  ['recalcCalcs','updateMIVF','updateNPO'].forEach(fn=>{
    if(typeof window[fn]==='function'){
      const orig = window[fn];
      window[fn]=function(){ const r = orig.apply(this, arguments); try{refresh();}catch(_){ } return r; };
    }
  });
  const moTgt = document.getElementById('surgCalcWrap') || document.getElementById('tab-calcs');
  if(moTgt && 'MutationObserver' in window){
    const mo = new MutationObserver(refresh);
    mo.observe(moTgt, {subtree:true, childList:true, characterData:true});
  }
});
</script>








<script>
// === LA Two-Bar Visualization + Hardened Add Agent ===
document.addEventListener('DOMContentLoaded', function(){
  function num(v){ const x=parseFloat(v); return (x>=0||x<0)?x:NaN; }
  function clamp(x,min,max){ return Math.max(min, Math.min(max,x)); }
  function barColor(p){ if(p<75) return '#4caf50'; if(p<100) return '#ffeb3b'; return '#f44336'; }

  const LA_CAPS = (window.LA_CAPS || { lidocaine:{plain:4.5, epi:7}, bupivacaine:{plain:2.5, epi:3}, ropivacaine:{plain:3, epi:3}, mepivacaine:{plain:5, epi:7} });
  const mgPerMlFromConc = (window.mgPerMlFromConc || function(c){ return c*10; });

  function getLaWeight(){
    const el=document.getElementById('laWeight'); const v=num(el&&el.value); return (v>0)?v:NaN;
  }

  function computeAgentMaxMg(){
    const drug=(document.getElementById('laDrug')||{}).value;
    const conc=num((document.getElementById('laConc')||{}).value);
    const epi=(document.getElementById('laEpi')||{}).value;
    const lw=getLaWeight();
    if(!(drug && (lw>0) && (conc>0))) return {ok:false};
    const perKg = (epi==='yes'? LA_CAPS[drug].epi : LA_CAPS[drug].plain);
    const agentMax = perKg * lw;
    return {ok:true, agentMaxMg:agentMax, perKg, conc};
  }

  function computePlannedMg(){
    const unit=(document.getElementById('laDoseUnit')||{}).value;
    const valEl=document.getElementById('laVolGiven');
    const v=num(valEl && valEl.value);
    const conc=num((document.getElementById('laConc')||{}).value);
    if(!(v>=0) || !(conc>0)) return {ok:false};
    if(unit==='mg') return {ok:true, mg:v};
    return {ok:true, mg: v * mgPerMlFromConc(conc)};
  }

  function paintBar(fillEl, pct){
    if(!fillEl) return;
    const p=clamp(Math.round(pct),0,150);
    fillEl.style.width = Math.min(p,100) + '%';
    fillEl.style.background = barColor(p);
    fillEl.parentElement.style.outline = (p>=100)? '2px solid #f44336' : '';
  }

  function updateAgentPlanBar(){
    const planFill=document.getElementById('laPlanFill');
    const pctLbl=document.getElementById('laPlanPct');
    const helper=document.getElementById('laPlanHelper');
    const maxInfo = computeAgentMaxMg();
    const planned = computePlannedMg();
    if(maxInfo.ok && planned.ok){
      const pct = 100*planned.mg / (maxInfo.agentMaxMg||1);
      paintBar(planFill, pct);
      if(pctLbl) pctLbl.textContent = Math.round(clamp(pct,0,150)) + '%';
      if(helper){
        const remaining = Math.max(0, maxInfo.agentMaxMg - planned.mg);
        helper.textContent = `Planned: ${planned.mg.toFixed(1)} mg | Max: ${Math.round(maxInfo.agentMaxMg)} mg | Remaining: ${remaining.toFixed(1)} mg`;
        helper.style.color = '';
      }
    } else {
      paintBar(planFill, 0);
      if(pctLbl) pctLbl.textContent = '0%';
      if(helper){ helper.textContent = 'Enter drug, concentration, epi, LA weight, and a planned dose.'; helper.style.color='var(--muted-2)'; }
    }
  }

  function updateOverallBar(){
    const fill=document.getElementById('laOverallFill');
    const pctLbl=document.getElementById('laOverallPct');
    const wEl=document.getElementById('wKg');
    const prev=wEl? wEl.value : null;
    const lw=getLaWeight();
    if(wEl) wEl.value = (lw>0)? String(lw) : '';
    let pct=0;
    try{
      if(typeof window.compositeFraction==='function'){ pct = Math.round(100*window.compositeFraction()); }
      else {
        const t=document.getElementById('laTotals');
        const m=t && (t.textContent||'').match(/(\d+)\s*%/);
        pct = m? parseInt(m[1],10) : 0;
      }
    }catch(_){ pct=0; } finally { if(wEl && prev!==null) wEl.value = prev; }
    paintBar(fill, pct);
    if(pctLbl) pctLbl.textContent = clamp(pct, 0, 150) + '%';
  }

  function recalcLAStandalone(){
    // Keep Max Dose/Vol in sync using LA weight
    const outDose=document.getElementById('laMaxDose');
    const outVol=document.getElementById('laMaxVol');
    const info=computeAgentMaxMg();
    if(outDose && outVol){
      if(info.ok){
        const maxVol = info.agentMaxMg / mgPerMlFromConc(info.conc);
        outDose.textContent = Math.round(info.agentMaxMg) + ' mg ('+info.perKg+' mg/kg)';
        outVol.textContent = maxVol.toFixed(1) + ' mL @ '+info.conc+'%';
      } else { outDose.textContent='—'; outVol.textContent='—'; }
    }
    updateAgentPlanBar();
    updateOverallBar();
  }

  // Harden addLAFromUI to ensure pushing to log and re-rendering even if original was truncated
  window.addLAFromUI = function(e){
    if(e) e.preventDefault();
    const drug=(document.getElementById('laDrug')||{}).value;
    const conc=num((document.getElementById('laConc')||{}).value);
    const epi=(document.getElementById('laEpi')||{}).value || 'no';
    const unit=(document.getElementById('laDoseUnit')||{}).value || 'mL';
    const input=document.getElementById('laVolGiven');
    const v=num(input && input.value);
    const lw=getLaWeight();
    if(!(drug && (conc>0) && (v>0) && (lw>0))) return;

    const mg = unit==='mg' ? v : (v * mgPerMlFromConc(conc));

    // Calculate remaining allowed mg based on current selections
    let allow = mg;
    try{
      if(typeof window.remainingForSelected==='function'){
        const rem = window.remainingForSelected();
        if(rem && rem.mg>=0) allow = Math.min(mg, rem.mg);
      }
    }catch(_){}

    // Read, append, save
    try{
      const LA_KEY='srna_la_log_v3';
      const getLA=()=>{ try{return JSON.parse(localStorage.getItem(LA_KEY)||'[]');}catch(e){return [];} };
      const saveLA=arr=>localStorage.setItem(LA_KEY, JSON.stringify(arr));
      const list=getLA();
      list.push({drug:drug, conc:conc, epi:epi, mg: allow});
      saveLA(list);
      if(input) input.value='';
      if(typeof window.renderLARows==='function') window.renderLARows();
      updateOverallBar();
    }catch(err){
      console.error('LA add failed:', err);
    }
  };

  // Wire events
  ['laWeight','laDrug','laConc','laEpi','laDoseUnit','laVolGiven'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.addEventListener('input', recalcLAStandalone); el.addEventListener('change', recalcLAStandalone); }
  });

  // Ensure "Add Agent" click uses our hardened function
  const addBtn=document.getElementById('laAdd');
  if(addBtn){ addBtn.addEventListener('click', window.addLAFromUI); }
  // Also handle Enter key in planned dose
  const addEnter=document.getElementById('laVolGiven');
  if(addEnter){ addEnter.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); window.addLAFromUI(ev); } }); }

  // Recalculate when rows are re-rendered
  if(typeof window.renderLARows==='function'){
    const __orig = window.renderLARows;
    window.renderLARows = function(){ const r=__orig.apply(this, arguments); try{ updateOverallBar(); }catch(_){ } return r; };
  }

  // Initial
  recalcLAStandalone();
});
</script>


<script>
// === Override LA calculations to use laWeight exclusively (no patient wKg usage) ===
document.addEventListener('DOMContentLoaded', function(){
  // helpers
  function num(v){ const x=parseFloat(v); return (x>=0||x<0)?x:NaN; }
  function getLaWeight(){
    const el = document.getElementById('laWeight');
    const v = num(el && el.value);
    return (v>0)? v : NaN;
  }
  // Access app constants
  const LA_CAPS = (window.LA_CAPS || { lidocaine:{plain:4.5, epi:7}, bupivacaine:{plain:2.5, epi:3}, ropivacaine:{plain:3, epi:3}, mepivacaine:{plain:5, epi:7} });
  const mgPerMlFromConc = (window.mgPerMlFromConc || function(c){ return c*10; });
  const LA_KEY='srna_la_log_v3';
  const getLA=()=>{ try{return JSON.parse(localStorage.getItem(LA_KEY)||'[]');}catch(e){return [];} };
  const saveLA=arr=>localStorage.setItem(LA_KEY, JSON.stringify(arr));

  // Fresh implementations that use laWeight
  function computeCompositeFractionWith(lw){
    if(!(lw>0)) return 0;
    let sum = 0;
    getLA().forEach(a => {
      const perKg=(a.epi==='yes'?LA_CAPS[a.drug].epi:LA_CAPS[a.drug].plain);
      const agentMax = perKg * lw;
      if(agentMax>0) sum += a.mg / agentMax;
    });
    return sum;
  }
  function totalsByAgent(){
    const t = {lidocaine:0, bupivacaine:0, ropivacaine:0, mepivacaine:0};
    getLA().forEach(a => { if (t.hasOwnProperty(a.drug)) t[a.drug] += a.mg; });
    return t;
  }
  window.remainingForSelected = function(){
    const drug = document.getElementById('laDrug')?.value;
    const conc = parseFloat((document.getElementById('laConc')?.value)||'0');
    const epi  = document.getElementById('laEpi')?.value || 'no';
    const lw    = getLaWeight();
    if(!drug || !(lw>0) || !(conc>0)) return {mg:0, ml:0, maxMg:0, givenMg:0};
    const perKg=(epi==='yes'?LA_CAPS[drug].epi:LA_CAPS[drug].plain);
    const agentMax = perKg * lw;
    const byAgent = totalsByAgent();
    const given = byAgent[drug] || 0;
    const compFrac = computeCompositeFractionWith(lw);
    const compRemaining = Math.max(0, (1 - compFrac) * agentMax);
    const agentRemaining = Math.max(0, agentMax - given);
    const mgAllowed = Math.min(compRemaining, agentRemaining);
    const mlAllowed = mgAllowed / mgPerMlFromConc(conc);
    return { mg: mgAllowed, ml: mlAllowed, maxMg: agentMax, givenMg: given };
  };

  // Override renderLARows to use laWeight for % calculations and maxes
  if (typeof window.renderLARows === 'function'){
    const _origDelHandlerInstalled = true; // original uses event delegation for delete
    window.renderLARows = function(){
      const tbody=document.getElementById('laTbody');
      const totalsEl=document.getElementById('laTotals');
      if(!tbody||!totalsEl) return;
      const lw = getLaWeight();
      const list = getLA();
      if(!list.length || !(lw>0)){
        tbody.innerHTML='<tr><td colspan="8" class="small" style="border:1px solid var(--border);padding:8px;color:var(--muted-2)">No agents added yet.</td></tr>';
        totalsEl.innerHTML='';
        if(typeof window.updateRemainingBadges==='function') window.updateRemainingBadges();
        // Also reset overall bar if present
        try{
          const fill = document.getElementById('laOverallFill');
          const lbl = document.getElementById('laOverallPct');
          if(fill){ fill.style.width='0%'; fill.style.background='#4caf50'; }
          if(lbl){ lbl.textContent='0%'; }
        }catch(_){}
        return;
      }
      let rows=''; let sumMg=0; let sumFraction=0;
      list.forEach((a,i)=>{
        const perKg=(a.epi==='yes'?LA_CAPS[a.drug].epi:LA_CAPS[a.drug].plain);
        const agentMaxMg=(lw>0?perKg*lw:0);
        const pct = agentMaxMg>0 ? (100*a.mg/agentMaxMg) : 0;
        sumMg += a.mg;
        sumFraction += (agentMaxMg>0 ? a.mg/agentMaxMg : 0);
        const mgPerMl = mgPerMlFromConc(a.conc);
        rows += ''
          + '<tr>'
          + `<td style="border:1px solid var(--border);padding:6px">${a.drug}</td>`
          + `<td style="border:1px solid var(--border);padding:6px">${a.conc}%</td>`
          + `<td style="border:1px solid var(--border);padding:6px">${a.epi==='yes'?'Yes':'No'}</td>`
          + `<td style="border:1px solid var(--border);padding:6px">${a.mg.toFixed(1)} mg</td>`
          + `<td style="border:1px solid var(--border);padding:6px">${mgPerMl.toFixed(1)} mg/mL</td>`
          + `<td style="border:1px solid var(--border);padding:6px">${agentMaxMg>0? Math.round(agentMaxMg)+' mg':'—'}</td>`
          + `<td style="border:1px solid var(--border);padding:6px">${Math.round(pct)}%</td>`
          + `<td style="border:1px solid var(--border);padding:6px"><button class="btn btn-danger" data-del="${i}">Delete</button></td>`
          + '</tr>';
      });
      tbody.innerHTML = rows;
      const overallPct = Math.round(100*sumFraction);
      const dangerAll = sumFraction>1;
      totalsEl.innerHTML = 'Total given: <span class="badge '+(dangerAll?'':'badge-soft')+'" style="'+(dangerAll?'background:var(--danger);color:#fff':'' )+'">'+Math.round(sumMg)+' mg ('+overallPct+'%)</span>';
      if(typeof window.updateRemainingBadges==='function') window.updateRemainingBadges();

      // Update overall bar (if present) without using patient wKg
      try{
        const fill=document.getElementById('laOverallFill');
        const lbl=document.getElementById('laOverallPct');
        if(fill){
          const pct = Math.max(0, Math.min(150, overallPct));
          fill.style.width = Math.min(pct, 100)+'%';
          fill.style.background = pct<75 ? '#4caf50' : (pct<100 ? '#ffeb3b' : '#f44336');
        }
        if(lbl){ lbl.textContent = (overallPct<0?0:overallPct>150?150:overallPct) + '%'; }
      }catch(_){}
    };
  }

  // Also override compositeFraction to our laWeight-based version for any code paths that still call it
  window.compositeFraction = function(){
    const lw = getLaWeight();
    return computeCompositeFractionWith(lw);
  };

  // Make sure "Add Agent" still works with our overrides
  const addBtn = document.getElementById('laAdd');
  if(addBtn && typeof window.addLAFromUI === 'function'){
    addBtn.removeEventListener && addBtn.removeEventListener('click', window.addLAFromUI);
    addBtn.addEventListener('click', window.addLAFromUI);
  }

  // Recalc when LA weight or fields change
  function recalcBarsAndTable(){
    try{
      if(typeof window.renderLARows==='function') window.renderLARows();
      // Update the agent planned bar (if our two-bar script exists)
      const planFill=document.getElementById('laPlanFill');
      if(planFill && typeof window.remainingForSelected==='function'){
        const drug=(document.getElementById('laDrug')||{}).value;
        const conc=num((document.getElementById('laConc')||{}).value);
        const epi=(document.getElementById('laEpi')||{}).value;
        const unit=(document.getElementById('laDoseUnit')||{}).value;
        const valEl=document.getElementById('laVolGiven');
        const v=num(valEl && valEl.value);
        let plannedMg = (unit==='mg')? v : (v * (conc>0? mgPerMlFromConc(conc):0));
        plannedMg = (plannedMg>=0? plannedMg: 0);
        const rem = window.remainingForSelected();
        const maxMg = rem.maxMg || 0;
        const pct = maxMg>0 ? Math.round(100*plannedMg/maxMg) : 0;
        planFill.style.width = Math.min(Math.max(pct,0),100)+'%';
        const lbl = document.getElementById('laPlanPct'); if(lbl) lbl.textContent = (pct<0?0:pct>150?150:pct)+'%';
      }
    }catch(_){}
  }
  ['laWeight','laDrug','laConc','laEpi','laDoseUnit','laVolGiven'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.addEventListener('input', recalcBarsAndTable); el.addEventListener('change', recalcBarsAndTable); }
  });
  // Initial render
  recalcBarsAndTable();
});
</script>


<script>
/* Ensure "Clear All" clears LA list and refreshes UI */
document.addEventListener('DOMContentLoaded', function(){
  const LA_KEY='srna_la_log_v3';
  function getLA(){ try{return JSON.parse(localStorage.getItem(LA_KEY)||'[]');}catch(e){return [];} }
  function saveLA(arr){ localStorage.setItem(LA_KEY, JSON.stringify(arr)); }
  function doClearAll(){
    try{
      saveLA([]);
      if (typeof window.renderLARows==='function') window.renderLARows();
      // Reset bars
      const planFill=document.getElementById('laPlanFill');
      const planLbl=document.getElementById('laPlanPct');
      if(planFill) planFill.style.width='0%';
      if(planLbl) planLbl.textContent='0%';
      const overFill=document.getElementById('laOverallFill');
      const overLbl=document.getElementById('laOverallPct');
      if(overFill) overFill.style.width='0%';
      if(overLbl) overLbl.textContent='0%';
    }catch(e){ console.error(e); }
  }
  const btn = document.getElementById('laClear');
  if(btn){
    btn.addEventListener('click', function(e){ e.preventDefault(); doClearAll(); });
  }
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  function num(v){ const x=parseFloat(v); return (x>=0||x<0)?x:NaN; }
  function getLaWeight(){
    const el=document.getElementById('laWeight');
    const v=num(el && el.value);
    return (v>0)? v : NaN;
  }
  function setText(id, val){ const el=document.getElementById(id); if(el) el.textContent = (val!=null && !isNaN(val)) ? String(val) : '—'; }

  function recomputeLAST(){
    const w = getLaWeight();
    if(!(w>0)){
      ['lastBolusMl','lastInfuse025MlMin','lastInfuse025MlHr','lastInfuse05MlMin','lastInfuse05MlHr','lastMax30Ml'].forEach(id=>setText(id,'—'));
      return;
    }
    const bolus = 1.5 * w;              // mL (1.5 mL/kg of 20%)
    const inf025_min = 0.25 * w;        // mL/min
    const inf025_hr = inf025_min * 60;  // mL/hr
    const inf05_min = 0.5 * w;          // mL/min
    const inf05_hr = inf05_min * 60;    // mL/hr
    const max30 = 10 * w;               // mL over first 30 min

    setText('lastBolusMl', Math.round(bolus));
    setText('lastInfuse025MlMin', +(inf025_min.toFixed(1)));
    setText('lastInfuse025MlHr', Math.round(inf025_hr));
    setText('lastInfuse05MlMin', +(inf05_min.toFixed(1)));
    setText('lastInfuse05MlHr', Math.round(inf05_hr));
    setText('lastMax30Ml', Math.round(max30));
  }

  ['laWeight'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.addEventListener('input', recomputeLAST); el.addEventListener('change', recomputeLAST); }
  });
  recomputeLAST();
});
</script>


<script>
/* --- Height Unit Handling & At-a-Glance Refresh (enhanced) --- */
document.addEventListener('DOMContentLoaded', function(){
  const hInput = document.getElementById('hCm');
  const uSel = document.getElementById('hUnit');

  // Helpers
  const toIn = cm => cm/2.54;
  const toCm = inch => inch*2.54;

  function getHeightCm(){
    if(!hInput||!uSel) return null;
    const raw = parseFloat(hInput.value);
    if(!(raw>=0)) return null;
    return uSel.value==='cm' ? raw : (raw*2.54);
  }
  window.getHeightCm = getHeightCm; // expose

  function updatePlaceholders(){
    if(!hInput||!uSel) return;
    hInput.placeholder = uSel.value==='cm' ? 'e.g., 170' : 'e.g., 67';
  }
  function convertOnUnitChange(oldUnit,newUnit){
    if(!hInput) return;
    const v = parseFloat(hInput.value);
    if(!(v>=0)) return;
    if(oldUnit==='cm' && newUnit==='in'){ hInput.value = (toIn(v)).toFixed(1); }
    if(oldUnit==='in' && newUnit==='cm'){ hInput.value = (toCm(v)).toFixed(0); }
  }

  function recomputeAtAGlance(){
    // Try to call the app's overall calculation if present
    if (typeof window.recalcCalcs === 'function') {
      try { window.recalcCalcs(); return; } catch(_){}
    }
    // Fallback: directly recompute BMI (kg/m^2), IBW (Devine), BSA (Mosteller) if elements exist
    const wEl = document.getElementById('wKg');
    const w = parseFloat(wEl && wEl.value) || NaN;
    const hcm = getHeightCm() || NaN;
    const h_m = hcm/100;
    const bmiEl = document.getElementById('bmiOut');
    const bsaEl = document.getElementById('bsaOut');
    const ibwEl = document.getElementById('ibwOut');
    const sexEl = document.getElementById('pSex');

    if(bmiEl && w>0 && h_m>0){ bmiEl.textContent = (w/(h_m*h_m)).toFixed(1); }
    if(bsaEl && w>0 && hcm>0){ bsaEl.textContent = (Math.sqrt((hcm*w)/3600)).toFixed(2)+' m²'; }
    if(ibwEl && hcm>0 && sexEl){
      const ht_in = hcm/2.54;
      const over5 = Math.max(0, ht_in - 60);
      const base = (sexEl.value==='F' ? 45.5 : 50);
      const ibw = base + 2.3*over5;
      ibwEl.textContent = ibw.toFixed(1)+' kg';
    }
  }

  // Wire up listeners
  if (hInput && uSel){
    updatePlaceholders();
    // Remember previous unit on focus
    uSel._prev = uSel.value;
    uSel.addEventListener('change', (e)=>{
      convertOnUnitChange(e.target._prev || 'cm', e.target.value);
      e.target._prev = e.target.value;
      updatePlaceholders();
      recomputeAtAGlance();
    });
    hInput.addEventListener('input', recomputeAtAGlance);
    // Also recompute when sex or weight changes (affects IBW/BMI)
    const wEl = document.getElementById('wKg');
    const sEl = document.getElementById('pSex');
    if(wEl) wEl.addEventListener('input', recomputeAtAGlance);
    if(sEl) sEl.addEventListener('change', recomputeAtAGlance);
  }

  // Initial recompute
  recomputeAtAGlance();
});
</script>


<script>
/* --- Height/At‑a‑Glance: robust recompute when DOM updates --- */
document.addEventListener('DOMContentLoaded', function(){
  function num(v){ const x=parseFloat(v); return (x>=0||x<0)?x:NaN; }
  const hInput = document.getElementById('hCm');
  const uSel = document.getElementById('hUnit');
  const wEl = document.getElementById('wKg');
  const sEl = document.getElementById('pSex');

  // canonical height in cm
  function getHeightCm(){
    if(!hInput||!uSel) return NaN;
    const raw = num(hInput.value);
    if(!(raw>0)) return NaN;
    return uSel.value==='cm' ? raw : (raw*2.54);
  }
  window.getHeightCm = getHeightCm; // expose for any other code paths

  function recomputeAtAGlance(){
    const hcm = getHeightCm();
    const w = num(wEl && wEl.value);
    const sex = (sEl && sEl.value) || ''; // '' -> assume Devine male baseline (50)
    const h_m = hcm/100;

    const bmiEl = document.getElementById('bmiOut');
    const bsaEl = document.getElementById('bsaOut');
    const ibwEl = document.getElementById('ibwOut');

    if(bmiEl) bmiEl.textContent = (w>0 && h_m>0) ? (w/(h_m*h_m)).toFixed(1) : '—';
    if(bsaEl) bsaEl.textContent = (w>0 && hcm>0) ? (Math.sqrt((hcm*w)/3600)).toFixed(2)+' m²' : '—';
    if(ibwEl){
      if(hcm>0){
        const ht_in = hcm/2.54;
        const over5 = Math.max(0, ht_in - 60);
        const base = (sex==='F' ? 45.5 : 50);
        const ibw = base + 2.3*over5;
        ibwEl.textContent = ibw.toFixed(1) + ' kg';
      } else {
        ibwEl.textContent = '—';
      }
    }
  }

  // Recompute on relevant inputs
  ;[hInput, uSel, wEl, sEl].forEach(el=>{
    if(el){ el.addEventListener('input', recomputeAtAGlance); el.addEventListener('change', recomputeAtAGlance); }
  });

  // Also recompute when At‑a‑Glance DOM gets (re)built by app code
  const ag = document.getElementById('atGlance');
  if(ag && 'MutationObserver' in window){
    const mo = new MutationObserver(()=>{ try{ recomputeAtAGlance(); }catch(_){} });
    mo.observe(ag, {childList:true, subtree:true});
  }

  // Initial
  recomputeAtAGlance();
});
</script>


<script>
/* === Reconstitution / Dilution Calculator === */
(function(){
  const $ = (id)=>document.getElementById(id);
  const stockVal = $('rc_stock_val');
  const stockUnit = $('rc_stock_unit');
  const goalVal  = $('rc_goal_val');
  const goalUnit = $('rc_goal_unit');
  const finalVol = $('rc_final_vol');
  const outDrug  = $('rc_out_drug');
  const outDil   = $('rc_out_dil');
  const outCheck = $('rc_out_check');
  const warn     = $('rc_warn');
  const preset   = $('rc_preset');

  function to_mcg_per_ml(value, unit){
    if(!value || value<=0) return null;
    return (unit==='mg_per_ml') ? value*1000 : value; // mg/mL -> mcg/mL
  }
  function roundSyringeML(x){
    if(x==null || !isFinite(x)) return null;
    return (Math.abs(x) <= 10) ? Math.round(x*100)/100 : Math.round(x*10)/10;
  }
  function roundConc(value){
    if(value==null || !isFinite(value)) return '—';
    if(value < 1000){
      return (Math.round(value*10)/10)+' mcg/mL';
    } else {
      return (Math.round((value/1000)*1000)/1000)+' mg/mL';
    }
  }

  function calc(){
    if(!stockVal || !goalVal || !finalVol) return;
    warn.textContent = '';
    outDrug.textContent = '—';
    outDil.textContent = '—';
    outCheck.textContent = '—';

    const Cs_mcg = to_mcg_per_ml(parseFloat(stockVal.value), stockUnit.value);
    const Cd_mcg = to_mcg_per_ml(parseFloat(goalVal.value),  goalUnit.value);
    const Vd     = parseFloat(finalVol.value);

    if(!Cs_mcg || !Cd_mcg || !Vd || Cs_mcg<=0 || Cd_mcg<=0 || Vd<=0) return;

    const drugVol = (Cd_mcg * Vd) / Cs_mcg;
    if(drugVol > Vd){
      warn.textContent = 'Warning: Desired concentration is higher than stock—cannot dilute upward.';
      return;
    }
    const dilVol  = Vd - drugVol;

    outDrug.textContent = roundSyringeML(drugVol)?.toString() ?? '—';
    outDil.textContent  = roundSyringeML(dilVol)?.toString() ?? '—';

    const checkCd_mcg = (Cs_mcg * drugVol) / Vd;
    outCheck.textContent = roundConc(checkCd_mcg);
  }

  ['input','change'].forEach(evt=>{
    if(stockVal){ stockVal.addEventListener(evt, calc); }
    if(stockUnit){ stockUnit.addEventListener(evt, calc); }
    if(goalVal){ goalVal.addEventListener(evt, calc); }
    if(goalUnit){ goalUnit.addEventListener(evt, calc); }
    if(finalVol){ finalVol.addEventListener(evt, calc); }
  });

  if(preset){
    preset.addEventListener('change', ()=>{
  const v = preset.value;
  if(v==='fentanyl_50_to_10_in_10'){
    stockVal.value = 50; stockUnit.value='mcg_per_ml';
    goalVal.value  = 10; goalUnit.value='mcg_per_ml';
    finalVol.value = 10;
  } else if(v==='hydromorphone_1_to_0_2_in_10'){
    stockVal.value = 1; stockUnit.value='mg_per_ml';
    goalVal.value  = 0.2; goalUnit.value='mg_per_ml';
    finalVol.value = 10;
  } else if(v==='epi_1_to_0_01_in_100'){
    stockVal.value = 1; stockUnit.value='mg_per_ml';
    goalVal.value  = 0.01; goalUnit.value='mg_per_ml';
    finalVol.value = 100;
  } else if(v==='ketamine_100_to_10_in_50'){
    stockVal.value = 100; stockUnit.value='mg_per_ml';
    goalVal.value  = 10;  goalUnit.value='mg_per_ml';
    finalVol.value = 50;
  } else if(v==='propofol_10_to_1_in_20'){
    stockVal.value = 10; stockUnit.value='mg_per_ml';
    goalVal.value  = 1;  goalUnit.value='mg_per_ml';
    finalVol.value = 20;
  } else if(v==='phenylephrine_10_to_0_1_in_100'){
    stockVal.value = 10; stockUnit.value='mg_per_ml';
    goalVal.value  = 0.1; goalUnit.value='mg_per_ml';
    finalVol.value = 100;
  } else if(v==='norepi_1_to_0_004_in_250'){
    stockVal.value = 1; stockUnit.value='mg_per_ml';
    goalVal.value  = 0.004; goalUnit.value='mg_per_ml';
    finalVol.value = 250;
  } else if(v==='vasopressin_20u_per_ml_to_0_4u_per_ml_in_50'){
    stockVal.value = 20; stockUnit.value='mg_per_ml'; // treat U/mL numerically for ratio calc
    goalVal.value  = 0.4; goalUnit.value='mg_per_ml';
    finalVol.value = 50;
  } else if(v==='lidocaine_2_to_1_in_20'){
    stockVal.value = 20; stockUnit.value='mg_per_ml'; // 2% = 20 mg/mL
    goalVal.value  = 10; goalUnit.value='mg_per_ml';
    finalVol.value = 20;
  } else {
    return;
  }
  calc();
});
  }

  // initialize
  calc();
})();
</script>

</body>
</html>
<script>
(function(){
  // Attempt to color-match the LA running total percent badge to the overall slider accent color
  function applyLaPercentColor(){
    try{
      // Find a likely "overall LA" slider
      const laSection = Array.from(document.querySelectorAll('.card, .section')).find(el => /Local\s*Anesth/i.test(el.textContent||''));
      const slider = laSection ? laSection.querySelector('input[type="range"]') : document.querySelector('input[type="range"]');
      const percentEl = document.querySelector('[id*="percent"][id*="la"], [id*="la"][id*="percent"], [id*="TotalGivenPercent"], [id*="laTotalPercent"]');
      if(!slider || !percentEl) return;

      // Prefer CSS variables already used for accent; fallback to computed styles
      const styles = getComputedStyle(slider);
      const accent = styles.getPropertyValue('--primary-600') || styles.getPropertyValue('--accent') || styles.color || '#3b82f6';

      // Apply as text/border background using existing badge classes by setting inline CSS vars
      percentEl.style.setProperty('--badge-bg', accent.trim());
      percentEl.style.setProperty('background', accent.trim());
      percentEl.style.setProperty('color', 'white');
      percentEl.style.setProperty('border-color', accent.trim());
      const parentBadge = percentEl.closest('.badge') || percentEl;
      if(parentBadge){
        parentBadge.style.setProperty('background', accent.trim());
        parentBadge.style.setProperty('color', 'white');
        parentBadge.style.setProperty('border-color', accent.trim());
      }
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', applyLaPercentColor);
  window.addEventListener('load', applyLaPercentColor);
})();
</script>
